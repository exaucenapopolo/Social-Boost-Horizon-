<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Espace Revendeur - Social Boost Horizon</title>

  <!-- Firebase compat (utilis√© pour l'√©coute temps r√©el du solde et auth c√¥t√© client) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@600;700;800&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <style>
    /* --- Styles repris et l√©g√®rement nettoy√©s pour clart√© --- */
    :root {
      --sbh-dark-blue: #0A162B;
      --sbh-gradient-start: #1e3c72;
      --sbh-gradient-end: #6a0dad;
      --sbh-btn-color: #1E90FF;
      --sbh-text-white: #FFFFFF;
      --sbh-text-light: rgba(255,255,255,0.9);
      --gold-primary: #FFD700;
      --reseller-beginner: #42A5F5;
      --reseller-amateur: #4CAF50;
      --reseller-intermediate: #FFC107;
      --reseller-professional: #FF5722;
      --resign-btn: #e74c3c;
      --resign-hover: #c0392b;
      --sbh-card-radius: 12px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Roboto', sans-serif;
      color: var(--sbh-text-white);
      background: var(--sbh-dark-blue);
      min-height: 100vh;
      display:flex; flex-direction:column;
    }

    /* Animation spinner keyframes */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }

    /* Background animation simplified */
    .background-animation {
      position: fixed; inset: 0; z-index: 0;
      background: linear-gradient(180deg, #061028 0%, #031022 100%);
      pointer-events:none;
      overflow:hidden;
    }
    .cloud { position:absolute; background:white; opacity:0.06; filter:blur(18px); border-radius:50%; }

    header {
      position: sticky; top:0; z-index:100;
      background: linear-gradient(45deg, var(--sbh-gradient-start), var(--sbh-gradient-end));
      display:flex; justify-content:space-between; align-items:center;
      padding: 1rem 1.5rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .logo-text { color:var(--sbh-text-white); text-decoration:none; display:flex; flex-direction:column; line-height:1.05; }
    .boost-line { display:flex; align-items:center; gap:6px; font-weight:800; }
    .snap-avatar { width:38px; height:38px; border-radius:50%; display:flex; align-items:center; justify-content:center; background: radial-gradient(circle at 30% 30%, #fffc00, #ffdc00 50%, #ffbc00); color:#0A162B; font-weight:700; }

    /* Balance */
    .balance-section {
      margin: 16px; padding:12px 18px; background: rgba(20,35,60,0.6); border-radius:12px;
      display:flex; justify-content:space-between; align-items:center; z-index:2;
    }
    .balance-section button { padding:8px 14px; border-radius:999px; border:none; cursor:pointer; background: linear-gradient(45deg,var(--sbh-gradient-start),var(--sbh-btn-color)); color:white; font-weight:600; }

    /* Container principal */
    .reseller-container { max-width:1200px; margin:0 auto; padding:16px; z-index:2; }

    .reseller-section { background: rgba(20,35,60,0.6); padding:20px; border-radius:12px; border:1px solid rgba(255,255,255,0.06); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }

    h1,h2,h3 { font-family:'Montserrat', sans-serif; color:var(--sbh-text-white); }
    h2 { font-size:1.5rem; margin-bottom:12px; }

    .reseller-status { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:14px; }
    .status-card { padding:14px; border-radius:12px; background: rgba(25,40,65,0.65); min-width:160px; text-align:center; border:1px solid rgba(255,255,255,0.06); position:relative; }
    .status-card .level { font-weight:700; font-size:1.4rem; margin:8px 0; color:var(--sbh-text-white); }

    .reseller-stats { display:flex; gap:12px; justify-content:center; margin-top:14px; flex-wrap:wrap; }
    .stat-box { background: rgba(30,45,70,0.8); border-radius:10px; padding:12px 18px; min-width:140px; text-align:center; border:1px solid rgba(255,255,255,0.06); }
    .stat-box .value { font-size:1.6rem; font-weight:700; color:var(--gold-primary); }
    .stat-box .label { font-size:0.85rem; color:var(--sbh-text-light); }

    .reseller-actions { display:flex; gap:12px; justify-content:center; margin-top:18px; flex-wrap:wrap; }
    .reseller-btn { padding:10px 18px; border-radius:999px; font-weight:700; cursor:pointer; border:none; display:inline-flex; align-items:center; gap:8px; }
    .btn-become-reseller { background: linear-gradient(45deg,var(--reseller-beginner),var(--reseller-amateur)); color:white; animation: pulse 2s infinite; }
    .btn-commander { background: linear-gradient(45deg,var(--reseller-intermediate),var(--reseller-professional)); color:white; }
    .btn-orders { background: linear-gradient(45deg,var(--sbh-gradient-start),var(--sbh-btn-color)); color:white; }
    .btn-dashboard { background: rgba(255,255,255,0.08); color:white; border:1px solid rgba(255,255,255,0.12); }
    .btn-resign { background: linear-gradient(45deg, var(--resign-btn), #d63031); color:white; }

    @keyframes pulse {
      0%{ box-shadow:0 0 0 0 rgba(66,165,245,0.6); }
      70%{ box-shadow:0 0 0 12px rgba(66,165,245,0); }
      100%{ box-shadow:0 0 0 0 rgba(66,165,245,0); }
    }

    .notification { position: fixed; top:20px; right:20px; padding:12px 16px; border-radius:8px; z-index:1200; color:white; box-shadow:0 6px 18px rgba(0,0,0,0.25); opacity:0; transform:translateY(-10px); transition: all .25s ease; }
    .notification.show { opacity:1; transform:translateY(0); }

    /* petits styles pour loader inline (optionnel) */
    .loading-spinner { display:inline-block; width:18px; height:18px; border:3px solid rgba(255,255,255,0.25); border-top-color:#fff; border-radius:50%; animation: spin 1s linear infinite; vertical-align:middle; margin-right:6px; }

    /* responsive */
    @media (max-width:768px) {
      header { padding:0.8rem; }
      .reseller-status, .reseller-stats { flex-direction:column; align-items:center; }
    }
  </style>
</head>
<body>
  <div class="background-animation" aria-hidden="true"></div>

  <header data-aos="fade-down">
    <a href="dashboard.html" class="logo-text" aria-label="Aller au dashboard">
      <span style="font-weight:700;">SOCIAL</span>
      <div class="boost-line" aria-hidden="true">
        <img src="https://raw.githubusercontent.com/exaucenapopolo/Social-Boost-Horizon-/refs/heads/main/assets/logos/Logo%20social%20Boost%20horizon.jpg"
             alt="Logo" style="height:28px; object-fit:cover;" onerror="this.style.display='none'">
        <span style="font-size:1.15rem;">BOOST</span>
      </div>
      <span style="font-size:0.95rem;">HORIZON</span>
    </a>

    <div style="display:flex; align-items:center; gap:12px;">
      <div id="balanceWrapper" class="snap-avatar" title="Votre solde" aria-live="polite"> <span id="balanceAmount">--</span> </div>
      <a href="profil.html" class="snap-avatar" title="Profil utilisateur">üë§</a>
    </div>
  </header>

  <main class="reseller-container" role="main">
    <section class="reseller-section" data-aos="fade-up">
      <h2><i class="fas fa-crown"></i> Programme Revendeur Social Boost Horizon</h2>
      <p>Devenez revendeur et b√©n√©ficiez de remises croissantes selon votre activit√©. Ici vous pouvez activer/d√©sactiver votre statut et consulter vos statistiques.</p>

      <div style="margin-top:12px; display:flex; gap:12px; flex-wrap:wrap;">
        <div style="flex:1; min-width:220px;">
          <div class="reseller-status" aria-hidden="false">
            <div class="status-card beginner" id="beginnerCard">
              <h3><i class="fas fa-seedling"></i> D√©butant</h3>
              <div class="level">5%</div>
              <div style="font-size:0.9rem; color:var(--sbh-text-light);">5-6 commandes / semaine</div>
            </div>
            <div class="status-card amateur" id="amateurCard">
              <h3><i class="fas fa-leaf"></i> Amateur</h3>
              <div class="level">10%</div>
              <div style="font-size:0.9rem; color:var(--sbh-text-light);">7-9 commandes / semaine</div>
            </div>
            <div class="status-card intermediate" id="intermediateCard">
              <h3><i class="fas fa-rocket"></i> Interm√©diaire</h3>
              <div class="level">15%</div>
              <div style="font-size:0.9rem; color:var(--sbh-text-light);">10-19 commandes / semaine</div>
            </div>
            <div class="status-card professional" id="professionalCard">
              <h3><i class="fas fa-crown"></i> Professionnel</h3>
              <div class="level">20%</div>
              <div style="font-size:0.9rem; color:var(--sbh-text-light);">20+ commandes / semaine</div>
            </div>
          </div>
        </div>

        <div style="flex:1; min-width:260px;">
          <div class="reseller-stats" role="region" aria-label="Statistiques revendeur">
            <div class="stat-box">
              <div class="value" id="currentLevel"><span class="loading-spinner" id="levelSpinner" style="display:inline-block;"></span><span>Chargement...</span></div>
              <div class="label"><i class="fas fa-chart-line"></i> Niveau actuel</div>
            </div>

            <div class="stat-box">
              <div class="value" id="discountRate"><span class="loading-spinner" id="discountSpinner" style="display:inline-block;"></span><span>0%</span></div>
              <div class="label"><i class="fas fa-percent"></i> Votre Remise</div>
            </div>

            <div class="stat-box">
              <div class="value" id="weeklyOrders"><span class="loading-spinner" id="weeklyOrdersSpinner" style="display:inline-block;"></span><span>0</span></div>
              <div class="label"><i class="fas fa-calendar-week"></i> Commandes (7j)</div>
            </div>

            <div class="stat-box">
              <div class="value" id="totalOrders"><span class="loading-spinner" id="ordersSpinner" style="display:inline-block;"></span><span>0</span></div>
              <div class="label"><i class="fas fa-shopping-basket"></i> Total Commandes</div>
            </div>

            <div class="stat-box">
              <div class="value" id="totalSavings"><span class="loading-spinner" id="savingsSpinner" style="display:inline-block;"></span><span>0 FCFA</span></div>
              <div class="label"><i class="fas fa-piggy-bank"></i> √âconomies Totales</div>
            </div>
          </div>
        </div>
      </div>

      <div class="reseller-actions" id="resellerActions" style="margin-top:18px;">
        <button class="reseller-btn btn-become-reseller" id="becomeResellerBtn" title="Activer le statut revendeur">
          <i class="fas fa-user-plus"></i> Devenir Revendeur
        </button>

        <a href="commandes.html" class="reseller-btn btn-orders" id="ordersBtn" style="display:none;">
          <i class="fas fa-shopping-cart"></i> Mes Commandes
        </a>

        <a href="command.html" class="reseller-btn btn-commander" id="commanderBtn" style="display:none;">
          <i class="fas fa-rocket"></i> Commander
        </a>

        <a href="dashboard.html" class="reseller-btn btn-dashboard" id="dashboardBtn" style="display:none;">
          <i class="fas fa-home"></i> Retour au Dashboard
        </a>

        <button class="reseller-btn btn-resign" id="resignBtn" style="display:none;">
          <i class="fas fa-sign-out-alt"></i> D√©missionner
        </button>

        <button class="reseller-btn" id="refreshStatsBtn" style="background: rgba(255,255,255,0.06); color:white;">
          <i class="fas fa-sync-alt"></i> Rafra√Æchir Stats
        </button>
      </div>
    </section>

    <!-- Services cards (affichage des prix remis√©s) -->
    <section class="reseller-section" data-aos="fade-up" style="margin-top:14px;">
      <h2><i class="fas fa-tags"></i> Nos services avec remise</h2>
      <p>Les prix affich√©s en mode "Revendeur" s'ajustent automatiquement selon votre remise.</p>

      <div style="display:grid; grid-template-columns: repeat(auto-fill,minmax(240px,1fr)); gap:12px; margin-top:12px;">
        <!-- Exemple : plusieurs cartes ‚Äî le JS mettra √† jour les .reseller-price -->
        <div class="status-card">
          <h3><i class="fab fa-instagram"></i> Followers Instagram</h3>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
            <div><small style="color:var(--sbh-text-light)">Normal</small><div style="font-weight:700;">2,500 FCFA</div></div>
            <div><small style="color:var(--sbh-text-light)">Revendeur</small><div class="reseller-price" data-original="2500">Calcul...</div><div style="font-size:0.85rem;color:var(--sbh-text-light)">√âconomisez <span class="savings-percent">0%</span></div></div>
          </div>
        </div>

        <div class="status-card">
          <h3><i class="fab fa-tiktok"></i> Likes TikTok</h3>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
            <div><small style="color:var(--sbh-text-light)">Normal</small><div style="font-weight:700;">500 FCFA</div></div>
            <div><small style="color:var(--sbh-text-light)">Revendeur</small><div class="reseller-price" data-original="500">Calcul...</div><div style="font-size:0.85rem;color:var(--sbh-text-light)">√âconomisez <span class="savings-percent">0%</span></div></div>
          </div>
        </div>

        <div class="status-card">
          <h3><i class="fab fa-youtube"></i> Vues YouTube</h3>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
            <div><small style="color:var(--sbh-text-light)">Normal</small><div style="font-weight:700;">1,550 FCFA</div></div>
            <div><small style="color:var(--sbh-text-light)">Revendeur</small><div class="reseller-price" data-original="1550">Calcul...</div><div style="font-size:0.85rem;color:var(--sbh-text-light)">√âconomisez <span class="savings-percent">0%</span></div></div>
          </div>
        </div>

        <div class="status-card">
          <h3><i class="fab fa-facebook"></i> Abonn√©s Facebook</h3>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
            <div><small style="color:var(--sbh-text-light)">Normal</small><div style="font-weight:700;">2,000 FCFA</div></div>
            <div><small style="color:var(--sbh-text-light)">Revendeur</small><div class="reseller-price" data-original="2000">Calcul...</div><div style="font-size:0.85rem;color:var(--sbh-text-light)">√âconomisez <span class="savings-percent">0%</span></div></div>
          </div>
        </div>

        <div class="status-card">
          <h3><i class="fab fa-twitter"></i> Followers Twitter</h3>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
            <div><small style="color:var(--sbh-text-light)">Normal</small><div style="font-weight:700;">1,800 FCFA</div></div>
            <div><small style="color:var(--sbh-text-light)">Revendeur</small><div class="reseller-price" data-original="1800">Calcul...</div><div style="font-size:0.85rem;color:var(--sbh-text-light)">√âconomisez <span class="savings-percent">0%</span></div></div>
          </div>
        </div>

        <div class="status-card">
          <h3><i class="fab fa-twitch"></i> Viewers Twitch</h3>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
            <div><small style="color:var(--sbh-text-light)">Normal</small><div style="font-weight:700;">2,200 FCFA</div></div>
            <div><small style="color:var(--sbh-text-light)">Revendeur</small><div class="reseller-price" data-original="2200">Calcul...</div><div style="font-size:0.85rem;color:var(--sbh-text-light)">√âconomisez <span class="savings-percent">0%</span></div></div>
          </div>
        </div>
      </div>
    </section>

    <section class="reseller-section" data-aos="fade-up" style="margin-top:14px;">
      <h2><i class="fas fa-info-circle"></i> Informations</h2>
      <ul style="margin-top:8px; color:var(--sbh-text-light); line-height:1.6;">
        <li><strong>V√©rification hebdomadaire</strong> : vos commandes des 7 derniers jours d√©terminent votre niveau.</li>
        <li><strong>Mise √† jour automatique</strong> : la plateforme recalcule vos stats ‚Äî vous pouvez aussi forcer la mise √† jour.</li>
        <li><strong>D√©mission</strong> : vous pouvez quitter le programme en cliquant sur "D√©missionner".</li>
      </ul>
    </section>
  </main>

  <!-- Notifications container -->
  <div id="notificationRoot" aria-live="polite" aria-atomic="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<script>
  AOS && AOS.init && AOS.init({ duration: 700, once: true });

  /* ===================== CONFIG ===================== */
  const SERVER_URL = "https://social-boost-exaucenapopolo2.replit.app"; // <-- v√©rifie cette URL si n√©cessaire

  const firebaseConfig = {
    apiKey: "AIzaSyD2JiDS0g8EkeNXxjO7_wGI3WznpPvcCCk",
    authDomain: "social-boost-horizon.firebaseapp.com",
    projectId: "social-boost-horizon",
    storageBucket: "social-boost-horizon.appspot.com",
    messagingSenderId: "43658165639",
    appId: "1:43658165639:web:b8f492dc6a25cd12fc6722"
  };

  /* Init Firebase (compat) ‚Äî safe init (√©vite double init si d√©j√† pr√©sent) */
  try {
    if (!window.firebase) throw new Error('Firebase non charg√© (v√©rifie les <script> firebase)');
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  } catch (e) {
    console.warn("Firebase initialization:", e);
  }
  const auth = firebase.auth();
  const db = firebase.firestore();

  /* ===================== DOM REFS ===================== */
  const balanceAmountEl = document.getElementById('balanceAmount');
  const balanceSpinner = document.getElementById('balanceSpinner'); // optionnel si tu en ajoutes plus tard
  const quickDepositBtn = document.getElementById('quickDeposit');   // optionnel

  const becomeResellerBtn = document.getElementById('becomeResellerBtn');
  const resignBtn = document.getElementById('resignBtn');
  const ordersBtn = document.getElementById('ordersBtn');
  const commanderBtn = document.getElementById('commanderBtn');
  const dashboardBtn = document.getElementById('dashboardBtn');
  const refreshStatsBtn = document.getElementById('refreshStatsBtn');

  const currentLevelEl = document.getElementById('currentLevel');
  const levelSpinner = document.getElementById('levelSpinner');
  const discountRateEl = document.getElementById('discountRate');
  const discountSpinner = document.getElementById('discountSpinner');
  const weeklyOrdersEl = document.getElementById('weeklyOrders');
  const weeklyOrdersSpinner = document.getElementById('weeklyOrdersSpinner');
  const totalOrdersEl = document.getElementById('totalOrders');
  const ordersSpinner = document.getElementById('ordersSpinner');
  const totalSavingsEl = document.getElementById('totalSavings');
  const savingsSpinner = document.getElementById('savingsSpinner');

  const beginnerCard = document.getElementById('beginnerCard');
  const amateurCard = document.getElementById('amateurCard');
  const intermediateCard = document.getElementById('intermediateCard');
  const professionalCard = document.getElementById('professionalCard');

  const notificationRoot = document.getElementById('notificationRoot') || document.body;

  /* ===================== STATE ===================== */
  let currentUser = null;
  let userListenerUnsubscribe = null;
  let userData = {
    isReseller: false,
    resellerLevel: null,
    resellerWeeklyOrders: 0,
    resellerTotalOrders: 0,
    discountRate: 0,
    balance: 0,
    totalSavings: 0
  };

  /* ===================== HELPERS ===================== */

  function showNotification(message, type = 'info', timeout = 4500) {
    const n = document.createElement('div');
    n.className = 'notification show';
    n.textContent = message;
    n.style.background = (type === 'success') ? 'linear-gradient(45deg,#4CAF50,#2E7D32)'
                   : (type === 'error')   ? 'linear-gradient(45deg,#f44336,#c62828)'
                   : 'linear-gradient(45deg,#2196F3,#1565C0)';
    n.style.color = '#fff';
    n.style.padding = '12px 16px';
    n.style.borderRadius = '8px';
    n.style.boxShadow = '0 6px 18px rgba(0,0,0,0.25)';
    n.style.position = 'fixed';
    n.style.top = '20px';
    n.style.right = '20px';
    n.style.zIndex = 99999;
    notificationRoot.appendChild(n);
    setTimeout(() => { n.style.transition = 'opacity .25s'; n.style.opacity = '0'; setTimeout(()=>{ try{ notificationRoot.removeChild(n); }catch(e){} },250); }, timeout);
  }

  function setStatBoxValue(boxEl, text) {
    if (!boxEl) return;
    const spans = boxEl.querySelectorAll('span');
    if (spans && spans.length >= 1) {
      spans[spans.length - 1].textContent = text;
    } else {
      boxEl.textContent = text;
    }
  }

  function getLevelColor(level) {
    if (!level) return 'rgba(255,255,255,0.4)';
    const l = String(level).toLowerCase();
    if (l.includes('begin') || l.includes('d√©but')) return 'rgba(66,165,245,0.45)';
    if (l.includes('amateur')) return 'rgba(76,175,80,0.45)';
    if (l.includes('inter')) return 'rgba(255,193,7,0.45)';
    if (l.includes('pro')) return 'rgba(255,87,34,0.45)';
    return 'rgba(255,255,255,0.45)';
  }

  function updateLevelIndicators() {
    document.querySelectorAll('.current-level-indicator').forEach(n => n.remove());
    [beginnerCard, amateurCard, intermediateCard, professionalCard].forEach(c => { if(c){ c.style.boxShadow=''; c.style.transform=''; }});

    if (!userData.isReseller || !userData.resellerLevel) return;
    const lvl = String(userData.resellerLevel).toLowerCase();
    let activeCard = null;
    if (lvl.includes('begin') || lvl.includes('d√©but')) activeCard = beginnerCard;
    else if (lvl.includes('amateur')) activeCard = amateurCard;
    else if (lvl.includes('inter')) activeCard = intermediateCard;
    else if (lvl.includes('pro')) activeCard = professionalCard;

    if (activeCard) {
      const indicator = document.createElement('div');
      indicator.className = 'current-level-indicator';
      indicator.style.position = 'absolute';
      indicator.style.top = '-10px';
      indicator.style.right = '-10px';
      indicator.style.background = 'var(--gold-primary)';
      indicator.style.color = '#0A162B';
      indicator.style.width = '28px';
      indicator.style.height = '28px';
      indicator.style.borderRadius = '50%';
      indicator.style.display = 'flex';
      indicator.style.alignItems = 'center';
      indicator.style.justifyContent = 'center';
      indicator.innerHTML = '<i class="fas fa-check" style="font-size:12px;"></i>';
      activeCard.appendChild(indicator);
      activeCard.style.boxShadow = `0 0 24px ${getLevelColor(userData.resellerLevel)}`;
      activeCard.style.transform = 'scale(1.04)';
    }
  }

  function updatePricesWithDiscount() {
    const discount = userData.isReseller ? Number(userData.discountRate || 0) : 0;
    document.querySelectorAll('.reseller-price').forEach(el => {
      const original = parseInt(el.getAttribute('data-original') || el.dataset.original, 10);
      if (!isNaN(original)) {
        const discounted = Math.round(original * (1 - discount/100));
        el.textContent = `${discounted.toLocaleString('fr-FR')} FCFA`;
        const parent = el.closest('.status-card') || el.parentElement;
        const savingsSpan = parent ? parent.querySelector('.savings-percent') : null;
        if (savingsSpan) savingsSpan.textContent = `${discount}%`;
      }
    });
  }

  function updateResellerUI() {
    try { if(levelSpinner) levelSpinner.style.display='none'; } catch(e){}
    try { if(discountSpinner) discountSpinner.style.display='none'; } catch(e){}
    try { if(weeklyOrdersSpinner) weeklyOrdersSpinner.style.display='none'; } catch(e){}
    try { if(ordersSpinner) ordersSpinner.style.display='none'; } catch(e){}
    try { if(savingsSpinner) savingsSpinner.style.display='none'; } catch(e){}
    try { if(balanceSpinner) balanceSpinner.style.display='none'; } catch(e){}

    if (userData.isReseller) {
      becomeResellerBtn && (becomeResellerBtn.style.display = 'none');
      ordersBtn && (ordersBtn.style.display = 'inline-flex');
      commanderBtn && (commanderBtn.style.display = 'inline-flex');
      dashboardBtn && (dashboardBtn.style.display = 'inline-flex');
      resignBtn && (resignBtn.style.display = 'inline-flex');
    } else {
      becomeResellerBtn && (becomeResellerBtn.style.display = 'inline-flex');
      ordersBtn && (ordersBtn.style.display = 'none');
      commanderBtn && (commanderBtn.style.display = 'none');
      dashboardBtn && (dashboardBtn.style.display = 'none');
      resignBtn && (resignBtn.style.display = 'none');
    }

    setStatBoxValue(currentLevelEl, userData.isReseller ? (userData.resellerLevel || 'N/A') : 'Non revendeur');
    setStatBoxValue(discountRateEl, (userData.discountRate || 0) + '%');
    setStatBoxValue(weeklyOrdersEl, String(userData.resellerWeeklyOrders || 0));
    setStatBoxValue(totalOrdersEl, String(userData.resellerTotalOrders || 0));
    setStatBoxValue(totalSavingsEl, (userData.totalSavings || 0).toLocaleString('fr-FR') + ' FCFA');

    if (balanceAmountEl) balanceAmountEl.textContent = `${(userData.balance || 0).toLocaleString('fr-FR')} FCFA`;

    updatePricesWithDiscount();
    updateLevelIndicators();
  }

  /* ===================== SERVER COMMUNICATION ===================== */

  // callServer am√©lior√© : v√©rifie content-type et renvoie message d'erreur lisible
  async function callServer(endpoint, method = 'GET', data = null) {
    try {
      const user = auth.currentUser;
      if (!user) throw new Error('Utilisateur non connect√©.');

      const token = await user.getIdToken();
      const opts = {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      };
      if (data && (method === 'POST' || method === 'PUT')) opts.body = JSON.stringify(data);

      console.log('callServer ->', method, `${SERVER_URL}${endpoint}`);
      const res = await fetch(`${SERVER_URL}${endpoint}`, opts);

      const contentType = res.headers.get('content-type') || '';
      let payload = null;

      if (contentType.includes('application/json')) {
        try { payload = await res.json(); }
        catch (e) { payload = null; }
      } else {
        // not JSON: read text for better error reporting
        const text = await res.text();
        console.warn('callServer: r√©ponse non-JSON:', res.status, text);
        if (!res.ok) {
          throw new Error(text || `Erreur serveur non-JSON (${res.status})`);
        } else {
          // success but not JSON: unexpected
          throw new Error('R√©ponse serveur inattendue (non JSON).');
        }
      }

      if (!res.ok) {
        const msg = payload?.error || payload?.message || `Erreur serveur (${res.status})`;
        throw new Error(msg);
      }
      return payload;
    } catch (err) {
      console.error('callServer error:', err);
      throw err;
    }
  }

  async function fetchUserData() {
    try {
      if (levelSpinner) levelSpinner.style.display = 'inline-block';
      if (discountSpinner) discountSpinner.style.display = 'inline-block';
      if (weeklyOrdersSpinner) weeklyOrdersSpinner.style.display = 'inline-block';
      if (ordersSpinner) ordersSpinner.style.display = 'inline-block';
      if (savingsSpinner) savingsSpinner.style.display = 'inline-block';
      if (balanceSpinner) balanceSpinner.style.display = 'inline-block';

      const res = await callServer('/user', 'GET');
      if (!res) throw new Error('R√©ponse vide du serveur /user.');

      const srvUser = res.user || (res.success && res.user) || null;
      if (!srvUser) {
        throw new Error(res.error || 'Format inattendu de la r√©ponse /user.');
      }

      userData = {
        isReseller: !!srvUser.isReseller,
        resellerLevel: srvUser.resellerLevel || null,
        resellerWeeklyOrders: Number(srvUser.resellerWeeklyOrders || 0),
        resellerTotalOrders: Number(srvUser.resellerTotalOrders || 0),
        discountRate: Number(srvUser.discountRate || 0),
        balance: Number(srvUser.balance || 0),
        totalSavings: Number(srvUser.totalSavings || 0),
        ...srvUser
      };

      updateResellerUI();
      return userData;
    } catch (err) {
      console.error('fetchUserData error:', err);
      showNotification(err.message || 'Impossible de charger vos donn√©es.', 'error');
      try { if(levelSpinner) levelSpinner.style.display='none'; } catch(e){}
      try { if(discountSpinner) discountSpinner.style.display='none'; } catch(e){}
      try { if(weeklyOrdersSpinner) weeklyOrdersSpinner.style.display='none'; } catch(e){}
      try { if(ordersSpinner) ordersSpinner.style.display='none'; } catch(e){}
      try { if(savingsSpinner) savingsSpinner.style.display='none'; } catch(e){}
      try { if(balanceSpinner) balanceSpinner.style.display='none'; } catch(e){}
      throw err;
    }
  }

  async function refreshResellerStats() {
    try {
      refreshStatsBtn && (refreshStatsBtn.disabled = true);
      refreshStatsBtn && (refreshStatsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mise √† jour...');
      const res = await callServer('/update-reseller-stats', 'GET');
      if (res && res.success) {
        await fetchUserData();
        showNotification('Statistiques mises √† jour.', 'success');
      } else {
        await fetchUserData();
      }
    } catch (err) {
      console.error('refreshResellerStats:', err);
      showNotification(err.message || 'Erreur mise √† jour stats', 'error');
    } finally {
      refreshStatsBtn && (refreshStatsBtn.disabled = false);
      if (refreshStatsBtn) refreshStatsBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Rafra√Æchir Stats';
    }
  }

  /* ===================== USER ACTIONS ===================== */

  async function becomeReseller() {
    if (!auth.currentUser) { showNotification('Veuillez vous connecter.', 'error'); return; }
    const originalHTML = becomeResellerBtn ? becomeResellerBtn.innerHTML : null;

    try {
      becomeResellerBtn.disabled = true;
      becomeResellerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Activation...';

      const res = await callServer('/become-reseller', 'POST');
      if (res && res.success) {
        showNotification(res.message || 'Vous √™tes maintenant revendeur.', 'success');
        await fetchUserData();
      } else {
        throw new Error(res.error || res.message || 'Activation √©chou√©e.');
      }
    } catch (err) {
      console.error('becomeReseller error:', err);
      showNotification(err.message || 'Erreur lors de l\'activation.', 'error');
    } finally {
      if (becomeResellerBtn) {
        becomeResellerBtn.disabled = false;
        becomeResellerBtn.innerHTML = originalHTML || '<i class="fas fa-user-plus"></i> Devenir Revendeur';
      }
    }
  }

  async function resignAsReseller() {
    if (!auth.currentUser) { showNotification('Veuillez vous connecter.', 'error'); return; }
    if (!confirm('√ätes-vous s√ªr de vouloir d√©missionner ? Vous perdrez vos avantages.')) return;
    const originalHTML = resignBtn ? resignBtn.innerHTML : null;

    try {
      resignBtn.disabled = true;
      resignBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> D√©mission...';

      const res = await callServer('/resign', 'POST');
      if (res && res.success) {
        showNotification(res.message || 'Vous avez d√©missionn√©.', 'info');
        await fetchUserData();
      } else {
        throw new Error(res.error || res.message || 'D√©mission √©chou√©e.');
      }
    } catch (err) {
      console.error('resignAsReseller:', err);
      showNotification(err.message || 'Erreur lors de la d√©mission.', 'error');
    } finally {
      if (resignBtn) {
        resignBtn.disabled = false;
        resignBtn.innerHTML = originalHTML || '<i class="fas fa-sign-out-alt"></i> D√©missionner';
      }
    }
  }

  /* ===================== FIRESTORE LISTENER ===================== */

  function setupFirestoreListener(uid) {
    try {
      if (typeof userListenerUnsubscribe === 'function') {
        try { userListenerUnsubscribe(); } catch(e) {}
        userListenerUnsubscribe = null;
      }
      if (!uid) return;

      const userRef = db.collection('users').doc(uid);
      userListenerUnsubscribe = userRef.onSnapshot(doc => {
        if (!doc.exists) return;
        const d = doc.data() || {};
        if (typeof d.balance !== 'undefined') {
          userData.balance = Number(d.balance || 0);
          if (balanceAmountEl) balanceAmountEl.textContent = `${userData.balance.toLocaleString('fr-FR')} FCFA`;
        }
        if (typeof d.isReseller !== 'undefined') userData.isReseller = !!d.isReseller;
        if (typeof d.resellerLevel !== 'undefined') userData.resellerLevel = d.resellerLevel;
        if (typeof d.resellerWeeklyOrders !== 'undefined') userData.resellerWeeklyOrders = Number(d.resellerWeeklyOrders || 0);
        if (typeof d.resellerTotalOrders !== 'undefined') userData.resellerTotalOrders = Number(d.resellerTotalOrders || 0);
        if (typeof d.discountRate !== 'undefined') userData.discountRate = Number(d.discountRate || 0);
        if (typeof d.totalSavings !== 'undefined') userData.totalSavings = Number(d.totalSavings || 0);
        updateResellerUI();
      }, err => {
        console.warn('Firestore listener error:', err);
      });
    } catch (err) {
      console.warn('setupFirestoreListener err:', err);
    }
  }

  /* ===================== EVENTS & INIT ===================== */

  function attachEvents() {
    if (becomeResellerBtn) becomeResellerBtn.addEventListener('click', becomeReseller);
    if (resignBtn) resignBtn.addEventListener('click', resignAsReseller);
    if (refreshStatsBtn) refreshStatsBtn.addEventListener('click', refreshResellerStats);
    if (quickDepositBtn) quickDepositBtn.addEventListener('click', () => location.href = 'fonds.html');
  }

  // Ping health (utile pour diagnostiquer serveur injoignable)
  async function pingServerHealth() {
    try {
      const r = await fetch(`${SERVER_URL}/health`);
      if (!r.ok) {
        const text = await r.text().catch(()=>null);
        console.warn('Health check failed:', r.status, text);
        showNotification('Serveur injoignable (health check). V√©rifie SERVER_URL.', 'error', 6000);
      } else {
        console.log('Serveur health OK');
      }
    } catch (err) {
      console.error('pingServerHealth error:', err);
      showNotification('Impossible de contacter le serveur. V√©rifie SERVER_URL.', 'error', 6000);
    }
  }

  auth.onAuthStateChanged(async (user) => {
    currentUser = user;
    if (user) {
      try {
        // ping rapide pour diagnostiquer probl√®mes r√©seau avant fetchUserData
        await pingServerHealth();
        await fetchUserData();
      } catch(e){
        console.warn('Erreur init user:', e);
      }
      setupFirestoreListener(user.uid);
    } else {
      userData = {
        isReseller: false,
        resellerLevel: null,
        resellerWeeklyOrders: 0,
        resellerTotalOrders: 0,
        discountRate: 0,
        balance: 0,
        totalSavings: 0
      };
      updateResellerUI();
      if (typeof userListenerUnsubscribe === 'function') { try { userListenerUnsubscribe(); } catch(e){} userListenerUnsubscribe = null; }
    }
  });

  attachEvents();

  /* si la page est ouverte et auth.currentUser d√©j√† pr√©sent */
  if (auth.currentUser) {
    (async () => {
      try { await pingServerHealth(); await fetchUserData(); setupFirestoreListener(auth.currentUser.uid); } catch(e){}
    })();
  }
  </script>
</body>
</html>