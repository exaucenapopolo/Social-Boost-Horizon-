<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Espace Revendeur — Social Boost Horizon</title>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <style>
    :root{
      --bg:#071026; --card:#15243a; --muted:rgba(255,255,255,0.75); --accent:#1E90FF; --gold:#FFD700;
      --success:#4CAF50; --warning:#FF9800; --error:#f44336;
    }
    *{box-sizing:border-box}
    body{font-family:Roboto,system-ui,-apple-system; margin:0; min-height:100vh; background:var(--bg); color:#fff; display:flex; flex-direction:column}
    header{display:flex; justify-content:space-between; align-items:center; padding:12px 18px; background:linear-gradient(90deg,#133064,#6a0dad); position:sticky; top:0; z-index:1000; box-shadow:0 2px 20px rgba(0,0,0,0.3)}
    .logo{font-weight:700; font-size:1.2rem; font-family:Montserrat, sans-serif}
    .snap{display:flex; gap:8px; align-items:center}
    .snap .avatar{background:radial-gradient(circle at 20% 20%, #fffc00,#ffbc00); color:#071026; padding:6px 10px; border-radius:999px; font-weight:700; min-width:60px; text-align:center}
    main{max-width:1100px; margin:18px auto; width:100%; padding:0 12px}
    .card{background:rgba(20,35,60,0.7); padding:20px; border-radius:16px; border:1px solid rgba(255,255,255,0.08); margin-bottom:20px; backdrop-filter:blur(10px); box-shadow:0 8px 32px rgba(0,0,0,0.2)}
    h2{font-family:Montserrat, sans-serif; margin-bottom:12px; display:flex; align-items:center; gap:10px}
    .reseller-status{display:flex; gap:12px; flex-wrap:wrap; justify-content:center}
    .status-card{background:rgba(255,255,255,0.05); padding:16px; border-radius:12px; min-width:160px; text-align:center; transition:all 0.3s ease; border:1px solid rgba(255,255,255,0.05); position:relative}
    .status-card:hover{transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,0.3)}
    .status-card.active{border-color:var(--accent); box-shadow:0 0 20px var(--accent)}
    .status-card .badge{position:absolute; top:-8px; right:-8px; background:var(--gold); color:#071026; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:bold}
    .reseller-actions{display:flex; gap:12px; flex-wrap:wrap; margin-top:16px}
    .btn{padding:12px 20px; border-radius:12px; border:0; cursor:pointer; font-weight:600; transition:all 0.3s ease; display:inline-flex; align-items:center; gap:8px; text-decoration:none; font-size:0.95rem}
    .btn-primary{background:linear-gradient(45deg,#42A5F5,#4CAF50); color:#fff; box-shadow:0 4px 15px rgba(66,165,245,0.3)}
    .btn-primary:hover{transform:translateY(-2px); box-shadow:0 6px 20px rgba(66,165,245,0.4)}
    .btn-secondary{background:rgba(255,255,255,0.08); color:#fff; border:1px solid rgba(255,255,255,0.1)}
    .btn-secondary:hover{background:rgba(255,255,255,0.12); transform:translateY(-1px)}
    .btn-danger{background:var(--error); color:#fff}
    .btn-danger:hover{background:#d32f2f; transform:translateY(-1px)}
    .small{font-size:0.9rem; color:var(--muted); line-height:1.5}
    .loading-spinner{display:inline-block; width:16px; height:16px; border:2px solid rgba(255,255,255,0.25); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite; vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    .notification{position:fixed; top:20px; right:20px; padding:16px 20px; border-radius:12px; z-index:9999; box-shadow:0 8px 30px rgba(0,0,0,.4); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.1); max-width:400px; animation:slideIn 0.3s ease}
    @keyframes slideIn{from{transform:translateX(100%); opacity:0}to{transform:translateX(0); opacity:1}}
    .stats-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:12px; margin-top:16px}
    .stat-item{background:rgba(255,255,255,0.03); padding:12px; border-radius:10px; text-align:center}
    .stat-value{font-size:1.4rem; font-weight:700; margin:5px 0; color:var(--accent)}
    .stat-label{font-size:0.8rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px}
    .price-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:12px; margin-top:16px}
    .price-card{background:rgba(255,255,255,0.03); padding:16px; border-radius:12px; border:1px solid rgba(255,255,255,0.05)}
    .price-card h3{margin:0 0 10px 0; font-size:1rem}
    .price-regular{color:var(--muted); text-decoration:line-through; font-size:0.9rem}
    .price-reseller{color:var(--success); font-weight:600; font-size:1.1rem}
    .level-badge{display:inline-block; padding:4px 12px; border-radius:20px; font-size:0.8rem; font-weight:600; margin-left:8px}
    .level-beginner{background:rgba(66,165,245,0.2); color:#42A5F5}
    .level-amateur{background:rgba(76,175,80,0.2); color:#4CAF50}
    .level-intermediate{background:rgba(255,193,7,0.2); color:#FFC107}
    .level-professional{background:rgba(255,87,34,0.2); color:#FF5722}
    @media (max-width:720px){ 
      .reseller-status{flex-direction:column; align-items:center} 
      .reseller-actions{flex-direction:column}
      .btn{justify-content:center}
      .stats-grid{grid-template-columns:repeat(2,1fr)}
    }
    .pulse{animation:pulse 2s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(66,165,245,0.7)}70%{box-shadow:0 0 0 10px rgba(66,165,245,0)}100%{box-shadow:0 0 0 0 rgba(66,165,245,0)}}
  </style>
</head>
<body>
  <header>
    <div class="logo">SOCIAL <span style="color:var(--gold)">BOOST</span> HORIZON</div>
    <div class="snap">
      <div id="balanceWrapper" class="avatar" title="Solde">--</div>
      <button id="quickDeposit" class="btn btn-secondary">Déposer</button>
      <a href="profil.html" class="btn btn-secondary">Profil</a>
    </div>
  </header>

  <main>
    <section class="card">
      <h2><i class="fas fa-crown"></i> Programme Revendeur</h2>
      <p class="small">Activez votre statut revendeur instantanément, consultez vos statistiques et bénéficiez des prix préférentiels.</p>

      <div style="display:flex; gap:16px; margin-top:16px; flex-wrap:wrap;">
        <div style="flex:1; min-width:260px">
          <div class="reseller-status">
            <div id="beginnerCard" class="status-card">
              <strong>Débutant</strong>
              <div>5% de remise</div>
              <div class="small">5–6 commandes/semaine</div>
            </div>
            <div id="amateurCard" class="status-card">
              <strong>Amateur</strong>
              <div>10% de remise</div>
              <div class="small">7–9 commandes/semaine</div>
            </div>
            <div id="intermediateCard" class="status-card">
              <strong>Intermédiaire</strong>
              <div>15% de remise</div>
              <div class="small">10–19 commandes/semaine</div>
            </div>
            <div id="professionalCard" class="status-card">
              <strong>Professionnel</strong>
              <div>20% de remise</div>
              <div class="small">20+ commandes/semaine</div>
            </div>
          </div>
        </div>

        <div style="flex:1; min-width:300px">
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-label">Niveau Actuel</div>
              <div id="currentLevel" class="stat-value">—</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Taux de Remise</div>
              <div id="discountRate" class="stat-value">—</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Commandes (7j)</div>
              <div id="weeklyOrders" class="stat-value">—</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Total Commandes</div>
              <div id="totalOrders" class="stat-value">—</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Économies Total</div>
              <div id="totalSavings" class="stat-value">—</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Solde Actuel</div>
              <div id="balanceAmount" class="stat-value">—</div>
            </div>
          </div>
        </div>
      </div>

      <div class="reseller-actions">
        <button id="becomeResellerBtn" class="btn btn-primary pulse"><i class="fas fa-user-plus"></i> Devenir Revendeur</button>
        <a id="ordersBtn" class="btn btn-secondary" href="commandes.html" style="display:none"><i class="fas fa-shopping-cart"></i> Mes Commandes</a>
        <a id="commanderBtn" class="btn btn-primary" href="command.html" style="display:none"><i class="fas fa-rocket"></i> Commander</a>
        <a id="dashboardBtn" class="btn btn-secondary" href="dashboard.html" style="display:none"><i class="fas fa-home"></i> Dashboard</a>
        <button id="resignBtn" class="btn btn-danger" style="display:none"><i class="fas fa-sign-out-alt"></i> Démissionner</button>
        <button id="refreshStatsBtn" class="btn btn-secondary"><i class="fas fa-sync-alt"></i> Rafraîchir</button>
      </div>
    </section>

    <section class="card">
      <h2><i class="fas fa-tags"></i> Prix Revendeur</h2>
      <p class="small">Les prix s'actualisent automatiquement selon votre niveau de remise actuel.</p>
      <div class="price-grid">
        <div class="price-card">
          <h3>Followers Instagram</h3>
          <div class="price-regular">Normal: 2 500 FCFA</div>
          <div class="price-reseller">Revendeur: <span class="reseller-price" data-original="2500">—</span></div>
        </div>
        <div class="price-card">
          <h3>Likes TikTok</h3>
          <div class="price-regular">Normal: 500 FCFA</div>
          <div class="price-reseller">Revendeur: <span class="reseller-price" data-original="500">—</span></div>
        </div>
        <div class="price-card">
          <h3>Vues YouTube</h3>
          <div class="price-regular">Normal: 1 550 FCFA</div>
          <div class="price-reseller">Revendeur: <span class="reseller-price" data-original="1550">—</span></div>
        </div>
        <div class="price-card">
          <h3>Abonnés TikTok</h3>
          <div class="price-regular">Normal: 3 200 FCFA</div>
          <div class="price-reseller">Revendeur: <span class="reseller-price" data-original="3200">—</span></div>
        </div>
      </div>
    </section>

    <section class="card small">
      <h2><i class="fas fa-info-circle"></i> Informations Importantes</h2>
      <ul>
        <li>Le statut revendeur est activé instantanément sans validation manuelle</li>
        <li>Vos statistiques sont mises à jour en temps réel</li>
        <li>Les prix revendeur s'appliquent immédiatement après activation</li>
        <li>Votre niveau évolue automatiquement selon votre activité</li>
      </ul>
    </section>
  </main>

  <div id="notificationRoot" aria-live="polite"></div>

  <script>
  // Configuration Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyD2JiDS0g8EkeNXxjO7_wGI3WznpPvcCCk",
    authDomain: "social-boost-horizon.firebaseapp.com",
    projectId: "social-boost-horizon",
    storageBucket: "social-boost-horizon.appspot.com",
    messagingSenderId: "43658165639",
    appId: "1:43658165639:web:b8f492dc6a25cd12fc6722"
  };

  // Initialisation Firebase
  if (typeof firebase !== 'undefined' && !firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Références DOM
  const balanceWrapper = document.getElementById('balanceWrapper');
  const balanceAmount = document.getElementById('balanceAmount');
  const becomeResellerBtn = document.getElementById('becomeResellerBtn');
  const resignBtn = document.getElementById('resignBtn');
  const ordersBtn = document.getElementById('ordersBtn');
  const commanderBtn = document.getElementById('commanderBtn');
  const dashboardBtn = document.getElementById('dashboardBtn');
  const refreshStatsBtn = document.getElementById('refreshStatsBtn');

  const currentLevelEl = document.getElementById('currentLevel');
  const discountRateEl = document.getElementById('discountRate');
  const weeklyOrdersEl = document.getElementById('weeklyOrders');
  const totalOrdersEl = document.getElementById('totalOrders');
  const totalSavingsEl = document.getElementById('totalSavings');

  const beginnerCard = document.getElementById('beginnerCard');
  const amateurCard = document.getElementById('amateurCard');
  const intermediateCard = document.getElementById('intermediateCard');
  const professionalCard = document.getElementById('professionalCard');

  const notificationRoot = document.getElementById('notificationRoot');

  let userData = {
    isReseller: false,
    resellerLevel: null,
    resellerWeeklyOrders: 0,
    resellerTotalOrders: 0,
    discountRate: 0,
    balance: 0,
    totalSavings: 0
  };

  let userUnsubscribe = null;

  // Fonction de notification améliorée
  function notify(msg, type = 'info', timeout = 4500) {
    const n = document.createElement('div');
    n.className = 'notification';
    n.style.background = type === 'error' ? 'rgba(217, 83, 79, 0.9)' : 
                        type === 'success' ? 'rgba(40, 167, 69, 0.9)' : 
                        'rgba(33, 150, 243, 0.9)';
    n.innerHTML = `
      <div style="display:flex; align-items:center; gap:10px;">
        <i class="fas ${type === 'error' ? 'fa-exclamation-triangle' : 
                     type === 'success' ? 'fa-check-circle' : 
                     'fa-info-circle'}"></i>
        <span>${msg}</span>
      </div>
    `;
    notificationRoot.appendChild(n);
    setTimeout(() => { 
      n.style.opacity = '0'; 
      n.style.transform = 'translateX(100%)';
      setTimeout(() => n.remove(), 300); 
    }, timeout);
  }

  // Mise à jour des statistiques
  function setStat(el, val) { 
    if (el) {
      el.textContent = val;
      el.classList.add('pulse');
      setTimeout(() => el.classList.remove('pulse'), 1000);
    }
  }

  // Calcul du niveau en fonction des commandes
  function calculateResellerLevel(weeklyOrders) {
    if (weeklyOrders >= 20) return { level: 'Professionnel', discount: 20, class: 'level-professional' };
    if (weeklyOrders >= 10) return { level: 'Intermédiaire', discount: 15, class: 'level-intermediate' };
    if (weeklyOrders >= 7) return { level: 'Amateur', discount: 10, class: 'level-amateur' };
    if (weeklyOrders >= 5) return { level: 'Débutant', discount: 5, class: 'level-beginner' };
    return { level: 'Débutant', discount: 5, class: 'level-beginner' }; // Niveau par défaut
  }

  // Mise à jour des indicateurs de niveau
  function updateLevelIndicators() {
    // Reset all cards
    [beginnerCard, amateurCard, intermediateCard, professionalCard].forEach(card => {
      if (card) {
        card.classList.remove('active');
        const badge = card.querySelector('.badge');
        if (badge) badge.remove();
      }
    });

    if (!userData.isReseller || !userData.resellerLevel) return;

    const level = userData.resellerLevel.toLowerCase();
    let activeCard = null;

    if (level.includes('débutant') || level.includes('beginner')) activeCard = beginnerCard;
    else if (level.includes('amateur')) activeCard = amateurCard;
    else if (level.includes('intermédiaire') || level.includes('intermediate')) activeCard = intermediateCard;
    else if (level.includes('professionnel') || level.includes('professional')) activeCard = professionalCard;

    if (activeCard) {
      activeCard.classList.add('active');
      const badge = document.createElement('div');
      badge.className = 'badge';
      badge.innerHTML = '<i class="fas fa-crown"></i>';
      activeCard.appendChild(badge);
    }
  }

  // Mise à jour des prix avec remise
  function updatePricesWithDiscount() {
    const discount = userData.isReseller ? Number(userData.discountRate || 0) : 0;
    document.querySelectorAll('.reseller-price').forEach(el => {
      const original = Number(el.getAttribute('data-original') || 0);
      if (!isNaN(original)) {
        const discounted = Math.round(original * (1 - discount / 100));
        el.textContent = `${discounted.toLocaleString('fr-FR')} FCFA`;
        el.setAttribute('title', `Économie de ${discount}%`);
      }
    });
  }

  // Mise à jour complète de l'interface
  function updateUI() {
    if (userData.isReseller) {
      const levelInfo = calculateResellerLevel(userData.resellerWeeklyOrders);
      setStat(currentLevelEl, userData.resellerLevel);
      currentLevelEl.innerHTML = `${userData.resellerLevel} <span class="level-badge ${levelInfo.class}">${levelInfo.discount}%</span>`;
      setStat(discountRateEl, userData.discountRate + '%');
      setStat(weeklyOrdersEl, userData.resellerWeeklyOrders);
      setStat(totalOrdersEl, userData.resellerTotalOrders);
      setStat(totalSavingsEl, userData.totalSavings.toLocaleString('fr-FR') + ' FCFA');
      
      // Affichage des boutons pour revendeur
      becomeResellerBtn.style.display = 'none';
      ordersBtn.style.display = 'inline-flex';
      commanderBtn.style.display = 'inline-flex';
      dashboardBtn.style.display = 'inline-flex';
      resignBtn.style.display = 'inline-flex';
    } else {
      setStat(currentLevelEl, 'Non revendeur');
      setStat(discountRateEl, '0%');
      setStat(weeklyOrdersEl, '0');
      setStat(totalOrdersEl, '0');
      setStat(totalSavingsEl, '0 FCFA');
      
      // Affichage des boutons pour non-revendeur
      becomeResellerBtn.style.display = 'inline-flex';
      ordersBtn.style.display = 'none';
      commanderBtn.style.display = 'none';
      dashboardBtn.style.display = 'none';
      resignBtn.style.display = 'none';
    }

    setStat(balanceAmount, userData.balance.toLocaleString('fr-FR') + ' FCFA');
    setStat(balanceWrapper, userData.balance.toLocaleString('fr-FR') + ' FCFA');
    
    updatePricesWithDiscount();
    updateLevelIndicators();
  }

  // Devenir revendeur directement via Firestore
  async function becomeReseller() {
    if (!auth.currentUser) {
      notify('Veuillez vous connecter pour devenir revendeur', 'error');
      return;
    }

    const userId = auth.currentUser.uid;
    const originalText = becomeResellerBtn.innerHTML;
    
    try {
      becomeResellerBtn.disabled = true;
      becomeResellerBtn.innerHTML = '<span class="loading-spinner"></span> Activation...';

      // Mise à jour directe dans Firestore
      await db.collection('users').doc(userId).update({
        isReseller: true,
        resellerLevel: 'Débutant',
        discountRate: 5,
        resellerSince: new Date(),
        resellerWeeklyOrders: 0,
        resellerTotalOrders: 0,
        totalSavings: 0
      });

      notify('Félicitations ! Vous êtes maintenant revendeur.', 'success');
      
    } catch (error) {
      console.error('Erreur lors de l\'activation revendeur:', error);
      notify('Erreur lors de l\'activation: ' + error.message, 'error');
    } finally {
      becomeResellerBtn.disabled = false;
      becomeResellerBtn.innerHTML = originalText;
    }
  }

  // Démissionner comme revendeur
  async function resignAsReseller() {
    if (!confirm('Êtes-vous sûr de vouloir démissionner ? Vous perdrez tous vos avantages revendeur.')) {
      return;
    }

    if (!auth.currentUser) {
      notify('Utilisateur non connecté', 'error');
      return;
    }

    const userId = auth.currentUser.uid;
    const originalText = resignBtn.innerHTML;
    
    try {
      resignBtn.disabled = true;
      resignBtn.innerHTML = '<span class="loading-spinner"></span> Démission...';

      await db.collection('users').doc(userId).update({
        isReseller: false,
        resellerLevel: null,
        discountRate: 0
      });

      notify('Vous avez démissionné en tant que revendeur.', 'info');
      
    } catch (error) {
      console.error('Erreur lors de la démission:', error);
      notify('Erreur lors de la démission: ' + error.message, 'error');
    } finally {
      resignBtn.disabled = false;
      resignBtn.innerHTML = originalText;
    }
  }

  // Rafraîchir les statistiques
  async function refreshResellerStats() {
    if (!auth.currentUser) {
      notify('Utilisateur non connecté', 'error');
      return;
    }

    const originalText = refreshStatsBtn.innerHTML;
    
    try {
      refreshStatsBtn.disabled = true;
      refreshStatsBtn.innerHTML = '<span class="loading-spinner"></span> Mise à jour...';

      // Simulation du recalcul des statistiques
      // Dans une vraie implémentation, vous pourriez recalculer les commandes de la semaine
      notify('Statistiques mises à jour', 'success');
      
    } catch (error) {
      console.error('Erreur lors du rafraîchissement:', error);
      notify('Erreur lors de la mise à jour: ' + error.message, 'error');
    } finally {
      refreshStatsBtn.disabled = false;
      refreshStatsBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Rafraîchir';
    }
  }

  // Écoute des changements d'authentification
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      // Désabonnement précédent si existant
      if (userUnsubscribe) {
        userUnsubscribe();
      }

      // Écoute en temps réel des données utilisateur
      userUnsubscribe = db.collection('users').doc(user.uid).onSnapshot(
        (doc) => {
          if (doc.exists) {
            const data = doc.data();
            userData = {
              isReseller: data.isReseller || false,
              resellerLevel: data.resellerLevel || null,
              resellerWeeklyOrders: data.resellerWeeklyOrders || 0,
              resellerTotalOrders: data.resellerTotalOrders || 0,
              discountRate: data.discountRate || 0,
              balance: data.balance || 0,
              totalSavings: data.totalSavings || 0
            };
            
            // Recalcul du niveau si nécessaire
            if (userData.isReseller) {
              const newLevel = calculateResellerLevel(userData.resellerWeeklyOrders);
              userData.resellerLevel = newLevel.level;
              userData.discountRate = newLevel.discount;
            }
            
            updateUI();
          }
        },
        (error) => {
          console.error('Erreur écoute Firestore:', error);
          notify('Erreur de connexion aux données', 'error');
        }
      );
      
    } else {
      // Utilisateur déconnecté
      if (userUnsubscribe) {
        userUnsubscribe();
        userUnsubscribe = null;
      }
      
      userData = {
        isReseller: false,
        resellerLevel: null,
        resellerWeeklyOrders: 0,
        resellerTotalOrders: 0,
        discountRate: 0,
        balance: 0,
        totalSavings: 0
      };
      updateUI();
      notify('Veuillez vous connecter', 'info');
    }
  });

  // Gestion des événements
  becomeResellerBtn.addEventListener('click', becomeReseller);
  resignBtn.addEventListener('click', resignAsReseller);
  refreshStatsBtn.addEventListener('click', refreshResellerStats);

  // Initialisation au chargement
  document.addEventListener('DOMContentLoaded', () => {
    if (auth.currentUser) {
      notify('Chargement de vos données revendeur...', 'info', 2000);
    }
  });

  // Gestion du dépôt rapide
  document.getElementById('quickDeposit')?.addEventListener('click', () => {
    notify('Redirection vers la page de dépôt...', 'info');
    setTimeout(() => {
      window.location.href = 'depot.html';
    }, 1000);
  });

  </script>
</body>
</html>