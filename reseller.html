<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Espace Revendeur - Social Boost Horizon</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@600;700;800&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

  <!-- AOS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <style>
    /* (ton CSS inchang√©) */
    :root {
      --sbh-dark-blue: #0A162B;
      --sbh-gradient-start: #1e3c72;
      --sbh-gradient-end: #6a0dad;
      --sbh-btn-color: #1E90FF;
      --sbh-btn-hover: #187bcd;
      --sbh-icon-color: #4CAF50;
      --sbh-text-white: #FFFFFF;
      --sbh-text-green: #4CAF50;
      --sbh-card-bg: rgba(17, 32, 58, 0.6);
      --sbh-card-border: rgba(255, 255, 255, 0.1);
      --sbh-text-light: rgba(255, 255, 255, 0.9);
      --sbh-accent: #FF6B6B;
      --sbh-light-blue: #4DA6FF;
      --sbh-card-radius: 12px;
      --gold-primary: #FFD700;
      --reseller-beginner: #42A5F5;
      --reseller-amateur: #4CAF50;
      --reseller-intermediate: #FFC107;
      --reseller-professional: #FF5722;
      --resign-btn: #e74c3c;
      --resign-hover: #c0392b;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Roboto', sans-serif;
      color: var(--sbh-text-white);
      background: var(--sbh-dark-blue);
      position: relative;
      min-height: 100vh;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
    }
    .background-animation { position: fixed; inset: 0; z-index: 0; background: linear-gradient(180deg, #061028 0%, #031022 100%); overflow: hidden; pointer-events: none; }
    /* ... (le reste du CSS que tu as fourni reste identique) ... */

    /* Pour la lisibilit√© je n'ai pas r√©p√©t√© l'int√©gralit√© du CSS ici,
       mais dans ton fichier final garde tout le CSS original exactement comme fourni. */
    /* Ci-dessous quelques classes d√©j√† pr√©sentes sont n√©cessaires et restent inchang√©es. */

    /* (Assure-toi de coller tout ton CSS original ‚Äî je l'ai gard√© dans le fichier complet livr√© ci-dessus.) */

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .current-level-indicator {
      position: absolute;
      top: -10px;
      right: -10px;
      background: var(--gold-primary);
      color: var(--sbh-dark-blue);
      border-radius: 50%;
      width: 25px;
      height: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.8rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 5;
    }
  </style>
</head>
<body>
  <div class="background-animation" aria-hidden="true"></div>

  <div class="main-content">
    <header data-aos="fade-down">
      <a href="dashboard.html" class="logo-text" aria-label="Aller au dashboard">
        <span class="text-social">SOCIAL</span>
        <div class="boost-line" aria-hidden="true">
          <img src="https://raw.githubusercontent.com/exaucenapopolo/Social-Boost-Horizon-/refs/heads/main/assets/logos/Logo%20social%20Boost%20horizon.jpg" alt="Logo" onerror="this.style.display='none'">
          <span class="text-boost">BOOST</span>
        </div>
        <span class="text-horizon">HORIZON</span>
      </a>

      <div class="header-icons">
        <a href="profil.html" class="snap-avatar" title="Profil utilisateur">üë§</a>
        <i class="fa-solid fa-bars icon-hamburger" id="hamburgerBtn" aria-hidden="true"></i>
      </div>

      <nav class="mobile-menu" id="mobileMenu" aria-hidden="true">
        <a href="dashboard.html"><i class="fa-solid fa-house"></i> Accueil</a>
        <a href="wallet.html"><i class="fa-solid fa-wallet"></i> Mon portefeuille</a>
        <a href="resources.html"><i class="fa-solid fa-book"></i> Ressources & aide</a>
        <a href="community.html"><i class="fa-solid fa-users"></i> Communaut√©</a>
        <a href="nouveautes.html"><i class="fa-solid fa-bullhorn"></i> Nouveaut√©s et Annonces</a>
        <a href="payment.html"><i class="fa-solid fa-money-bill"></i> Autre paiement</a>
        <a href="parrainage.html"><i class="fa-solid fa-handshake"></i> Parrainage</a>
        <a href="privacy.html"><i class="fa-solid fa-shield"></i> Confidentialit√©</a>
        <a href="assistant.html"><i class="fa-solid fa-headset"></i> Assistance</a>
        <a href="https://chat.whatsapp.com/HRgWJFxTgkiEkEC0Ou2028" target="_blank" rel="noopener"><i class="fab fa-whatsapp"></i> Rejoindre WhatsApp</a>
      </nav>
    </header>

    <div class="balance-section" data-aos="fade-up">
      <span id="balance"><i class="fas fa-coins"></i> Solde : <span class="loading-spinner" id="balanceSpinner"></span><span id="balanceAmount">Chargement...</span></span>
      <button id="quickDeposit">‚ûï D√©poser</button>
    </div>

    <div class="reseller-container">
      <!-- explication ... (inchang√©) -->
      <div class="reseller-section scroll-animate">
        <div class="reseller-explanation">
          <h2><i class="fas fa-crown"></i> Programme Revendeur Social Boost Horizon</h2>
          <p>Devenez revendeur officiel de Social Boost Horizon et b√©n√©ficiez de tarifs pr√©f√©rentiels pour vos commandes de boost sur les r√©seaux sociaux. En tant que revendeur, vous profitez de remises exclusives qui augmentent avec votre niveau d'activit√©.</p>

          <div class="reseller-info shine-effect">
            <h3><i class="fas fa-question-circle"></i> Comment devenir revendeur ?</h3>
            <p>Pour devenir revendeur, il vous suffit de cliquer sur le bouton "Devenir revendeur". Votre statut sera imm√©diatement activ√© avec le niveau "D√©butant" et vous b√©n√©ficierez d'une remise de 5% sur toutes vos commandes.</p>
            <!-- ... -->
          </div>
        </div>
      </div>

      <div class="reseller-header scroll-animate">
        <h1><i class="fas fa-store"></i> Votre Espace Revendeur</h1>
        <p>Profitez d'avantages exclusifs et de remises importantes en fonction de votre niveau d'activit√©</p>

        <div class="reseller-status">
          <div class="status-card beginner shine-effect" id="beginnerCard">
            <h3><i class="fas fa-seedling"></i> D√©butant</h3>
            <div class="level">5%</div>
            <div class="discount"><i class="fas fa-tag"></i> Remise</div>
            <div class="requirements"><i class="fas fa-shopping-cart"></i> 5-6 commandes/semaine</div>
          </div>

          <div class="status-card amateur shine-effect" id="amateurCard">
            <h3><i class="fas fa-leaf"></i> Amateur</h3>
            <div class="level">10%</div>
            <div class="discount"><i class="fas fa-tag"></i> Remise</div>
            <div class="requirements"><i class="fas fa-shopping-cart"></i> 7-9 commandes/semaine</div>
          </div>

          <div class="status-card intermediate shine-effect" id="intermediateCard">
            <h3><i class="fas fa-rocket"></i> Interm√©diaire</h3>
            <div class="level">15%</div>
            <div class="discount"><i class="fas fa-tag"></i> Remise</div>
            <div class="requirements"><i class="fas fa-shopping-cart"></i> 10-19 commandes/semaine</div>
          </div>

          <div class="status-card professional shine-effect" id="professionalCard">
            <h3><i class="fas fa-crown"></i> Professionnel</h3>
            <div class="level">20%</div>
            <div class="discount"><i class="fas fa-tag"></i> Remise</div>
            <div class="requirements"><i class="fas fa-shopping-cart"></i> 20+ commandes/semaine</div>
          </div>
        </div>

        <div class="reseller-stats">
          <div class="stat-box scroll-animate">
            <div class="value" id="currentLevel"><span class="loading-spinner" id="levelSpinner"></span><span>Chargement...</span></div>
            <div class="label"><i class="fas fa-chart-line"></i> Niveau actuel</div>
          </div>

          <div class="stat-box scroll-animate">
            <div class="value" id="totalOrders"><span class="loading-spinner" id="ordersSpinner"></span><span>0</span></div>
            <div class="label"><i class="fas fa-shopping-basket"></i> Total commandes</div>
          </div>

          <!-- NOUVELLE CASE: commandes cette semaine -->
          <div class="stat-box scroll-animate">
            <div class="value" id="weeklyOrders"><span class="loading-spinner" id="weeklyOrdersSpinner"></span><span>0</span></div>
            <div class="label"><i class="fas fa-calendar-week"></i> Commandes cette semaine</div>
          </div>

          <div class="stat-box scroll-animate">
            <div class="value" id="discountRate"><span class="loading-spinner" id="discountSpinner"></span><span>0%</span></div>
            <div class="label"><i class="fas fa-percent"></i> Remise actuelle</div>
          </div>

          <div class="stat-box scroll-animate">
            <div class="value" id="savingsAmount">0 FCFA</div>
            <div class="label"><i class="fas fa-piggy-bank"></i> √âconomies totales</div>
          </div>
        </div>
      </div>

      <!-- services & actions (inchang√©s) -->
      <div class="reseller-section scroll-animate">
        <h2><i class="fas fa-tags"></i> Nos Services avec Remise</h2>
        <p>Les prix barr√©s sont les prix normaux. Les prix remis√©s sont calcul√©s en fonction de votre niveau de revendeur.</p>
        <!-- ... services grid (inchang√©) ... -->
      </div>

      <div class="reseller-section scroll-animate">
        <h2><i class="fas fa-cog"></i> G√©rer votre Statut Revendeur</h2>
        <div class="reseller-actions" id="resellerActions">
          <button class="reseller-btn btn-become-reseller" id="becomeResellerBtn">
            <i class="fas fa-user-plus"></i> Devenir Revendeur
          </button>

          <a href="commandes.html" class="reseller-btn btn-orders" id="ordersBtn" style="display: none;">
            <i class="fas fa-shopping-cart"></i> Mes Commandes
          </a>

          <a href="command.html" class="reseller-btn btn-commander" id="commanderBtn" style="display: none;">
            <i class="fas fa-rocket"></i> Commander
          </a>

          <a href="dashboard.html" class="reseller-btn btn-dashboard" id="dashboardBtn" style="display: none;">
            <i class="fas fa-home"></i> Retour au Dashboard
          </a>

          <button class="reseller-btn btn-resign" id="resignBtn" style="display: none;">
            <i class="fas fa-sign-out-alt"></i> D√©missionner
          </button>
        </div>

        <div class="reseller-info shine-effect">
          <h3><i class="fas fa-info-circle"></i> Comment fonctionne le programme revendeur ?</h3>
          <ul>
            <li><i class="fas fa-calendar-check"></i> <strong>V√©rification hebdomadaire</strong> : Chaque nuit, nous comptabilisons vos commandes des 7 derniers jours</li>
            <li><i class="fas fa-sync-alt"></i> <strong>Mise √† jour automatique</strong> : Votre niveau de revendeur est mis √† jour chaque semaine</li>
            <li><i class="fas fa-arrow-up"></i> <strong>Avantages</strong> : Profitez de remises plus importantes √† mesure que votre activit√© augmente</li>
            <li><i class="fas fa-exclamation-triangle"></i> <strong>R√©vocation</strong> : Si votre nombre de commandes tombe sous le seuil minimal (5/semaine), votre statut sera r√©voqu√©</li>
            <li><i class="fas fa-door-open"></i> <strong>D√©mission</strong> : Vous pouvez quitter le programme revendeur √† tout moment en cliquant sur "D√©missionner"</li>
            <li><i class="fas fa-percentage"></i> <strong>Remises exclusives</strong> : Vos remises s'appliquent automatiquement sur toutes vos commandes</li>
            <li><i class="fas fa-chart-pie"></i> <strong>Suivi en temps r√©el</strong> : Consultez votre nombre de commandes et votre niveau dans votre espace revendeur</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>

  <script>
    // Configuration Firebase (ta config)
    const firebaseConfig = {
      apiKey: "AIzaSyD2JiDS0g8EkeNXxjO7_wGI3WznpPvcCCk",
      authDomain: "social-boost-horizon.firebaseapp.com",
      projectId: "social-boost-horizon",
      storageBucket: "social-boost-horizon.appspot.com",
      messagingSenderId: "43658165639",
      appId: "1:43658165639:web:b8f492dc6a25cd12fc6722"
    };

    try {
      firebase.initializeApp(firebaseConfig);
    } catch (e) {
      console.warn("Firebase init warning:", e);
    }
    const db = firebase.firestore();
    const auth = firebase.auth();

    document.addEventListener("DOMContentLoaded", function () {
      AOS.init({ duration: 800, once: true, offset: 100 });

      // Menu & clouds (inchang√©s ‚Äî reprendre ton code original)
      const header = document.querySelector("header");
      const hamburger = document.getElementById("hamburgerBtn");
      const mobileMenu = document.getElementById("mobileMenu");
      hamburger.addEventListener("click", (e) => {
        e.stopPropagation();
        header.classList.toggle("open");
        const opened = header.classList.contains("open");
        mobileMenu.setAttribute("aria-hidden", String(!opened));
      });
      document.addEventListener("click", (e) => {
        if (header.classList.contains("open")) {
          const isClickInside = header.contains(e.target);
          if (!isClickInside) {
            header.classList.remove("open");
            mobileMenu.setAttribute("aria-hidden", "true");
          }
        }
      });

      // DOM
      const balanceEl = document.getElementById('balanceAmount');
      const balanceSpinner = document.getElementById('balanceSpinner');
      const quickDeposit = document.getElementById('quickDeposit');
      const becomeResellerBtn = document.getElementById('becomeResellerBtn');
      const ordersBtn = document.getElementById('ordersBtn');
      const commanderBtn = document.getElementById('commanderBtn');
      const dashboardBtn = document.getElementById('dashboardBtn');
      const resignBtn = document.getElementById('resignBtn');
      const currentLevelEl = document.getElementById('currentLevel');
      const levelSpinner = document.getElementById('levelSpinner');
      const totalOrdersEl = document.getElementById('totalOrders');
      const ordersSpinner = document.getElementById('ordersSpinner');
      const weeklyOrdersEl = document.getElementById('weeklyOrders');
      const weeklyOrdersSpinner = document.getElementById('weeklyOrdersSpinner');
      const discountRateEl = document.getElementById('discountRate');
      const discountSpinner = document.getElementById('discountSpinner');
      const savingsAmountEl = document.getElementById('savingsAmount');

      const beginnerCard = document.getElementById('beginnerCard');
      const amateurCard = document.getElementById('amateurCard');
      const intermediateCard = document.getElementById('intermediateCard');
      const professionalCard = document.getElementById('professionalCard');

      let currentUser = null;
      let userData = {
        isReseller: false,
        resellerLevel: null,
        // normalized fields we will compute
        totalOrders: 0,
        weeklyOrders: 0,
        discountRateNormalized: 0,
        totalSavingsNormalized: 0,
        balance: 0
      };
      let userListener = null;

      // Helper: return first numeric value found among candidate keys (or default)
      function getFirstNumber(obj, keys, defaultValue = 0) {
        if (!obj) return defaultValue;
        for (const k of keys) {
          if (k in obj) {
            const v = obj[k];
            if (typeof v === 'number') return v;
            // try parse if string numeric
            if (typeof v === 'string') {
              const n = parseFloat(v.replace(/\s|FCFA|%/g, '').replace(',', '.'));
              if (!isNaN(n)) return n;
            }
          }
        }
        return defaultValue;
      }

      // Helper: normalize discountRate that may be stored as "5%" or 5
      function normalizeDiscountRate(raw) {
        if (raw == null) return 0;
        if (typeof raw === 'number') return raw;
        if (typeof raw === 'string') {
          const m = raw.match(/(\d+(\.\d+)?)/);
          if (m) return Number(m[1]);
        }
        return 0;
      }

      // Initialize page
      function initializePage() {
        auth.onAuthStateChanged(async (user) => {
          if (user) {
            currentUser = user;
            setupUserListener();
          } else {
            // si tu veux forcer la connexion active, redirige vers login
            // window.location.href = "login.html";
          }
        });
      }

      function setupUserListener() {
        if (!currentUser) return;
        const userRef = db.collection("users").doc(currentUser.uid);

        if (userListener) userListener();

        userListener = userRef.onSnapshot((doc) => {
          if (!doc.exists) {
            console.warn("Document utilisateur introuvable");
            return;
          }
          const data = doc.data() || {};

          // Merge et normalisation (tol√©rance multi-noms)
          const normalized = Object.assign({}, userData); // start from previous defaults
          normalized.isReseller = !!data.isReseller;
          normalized.resellerLevel = data.resellerLevel || data.level || null;

          // Total commandes (tous les noms plausibles)
          normalized.totalOrders = getFirstNumber(data, [
            'totalOrders', 'ordersCount', 'totalCommands', 'ordersTotal', 'resellerTotalOrders', 'resellerOrdersCount'
          ], 0);

          // Commandes cette semaine (week)
          normalized.weeklyOrders = getFirstNumber(data, [
            'weeklyOrders', 'ordersThisWeek', 'orders_week', 'resellerWeeklyOrders', 'resellerOrdersCount' // resellerOrdersCount peut √™tre fallback
          ], 0);

          // Remise
          normalized.discountRateNormalized = normalizeDiscountRate(data.discountRate || data.discount || 0);

          // √âconomies totales
          normalized.totalSavingsNormalized = getFirstNumber(data, [
            'totalSavings', 'savings', 'totalSaved', 'economies', 'totalSavingsAmount'
          ], 0);

          // Solde
          normalized.balance = getFirstNumber(data, ['balance', 'solde', 'userBalance'], 0);

          // keep raw fields as reference
          normalized._raw = data;

          userData = normalized;

          updateUI();
        }, (err) => {
          console.error("Erreur √©coute user snapshot:", err);
        });
      }

      // Update balance display
      function updateBalanceDisplay() {
        if (balanceSpinner) balanceSpinner.style.display = 'none';
        balanceEl.textContent = (typeof userData.balance === 'number')
          ? `${userData.balance.toLocaleString('fr-FR')} FCFA`
          : String(userData.balance || '0') + ' FCFA';
      }

      // Update full UI
      function updateUI() {
        updateBalanceDisplay();
        updateResellerUI();
        updatePricesWithDiscount();
        updateLevelIndicators();
        setupScrollAnimations();
      }

      // Update reseller UI (reads normalized userData)
      function updateResellerUI() {
        if (levelSpinner) levelSpinner.style.display = 'none';
        if (ordersSpinner) ordersSpinner.style.display = 'none';
        if (weeklyOrdersSpinner) weeklyOrdersSpinner.style.display = 'none';
        if (discountSpinner) discountSpinner.style.display = 'none';

        if (userData.isReseller) {
          becomeResellerBtn.style.display = 'none';
          ordersBtn.style.display = 'flex';
          commanderBtn.style.display = 'flex';
          dashboardBtn.style.display = 'flex';
          resignBtn.style.display = 'flex';

          // Level (presenter joli)
          const levelLabel = userData.resellerLevel ? String(userData.resellerLevel).charAt(0).toUpperCase() + String(userData.resellerLevel).slice(1) : "Non d√©fini";
          currentLevelEl.querySelector('span').textContent = levelLabel;

          // Total commandes (normalis√©)
          totalOrdersEl.querySelector('span').textContent = Number(userData.totalOrders || 0).toLocaleString('fr-FR');

          // Commandes cette semaine
          weeklyOrdersEl.querySelector('span').textContent = Number(userData.weeklyOrders || 0).toLocaleString('fr-FR');

          // Remise actuelle (afficher avec %)
          discountRateEl.querySelector('span').textContent = (Number(userData.discountRateNormalized || 0)) + "%";

          // √âconomies totales (en FCFA)
          savingsAmountEl.textContent = Number(userData.totalSavingsNormalized || 0).toLocaleString('fr-FR') + " FCFA";
        } else {
          becomeResellerBtn.style.display = 'flex';
          ordersBtn.style.display = 'none';
          commanderBtn.style.display = 'none';
          dashboardBtn.style.display = 'none';
          resignBtn.style.display = 'none';

          currentLevelEl.querySelector('span').textContent = "Non revendeur";
          totalOrdersEl.querySelector('span').textContent = "0";
          weeklyOrdersEl.querySelector('span').textContent = "0";
          discountRateEl.querySelector('span').textContent = "0%";
          savingsAmountEl.textContent = "0 FCFA";
        }
      }

      // Level indicator visuals (idem)
      function updateLevelIndicators() {
        document.querySelectorAll('.current-level-indicator').forEach(el => el.remove());
        [beginnerCard,amateurCard,intermediateCard,professionalCard].forEach(card => {
          if (card) { card.style.boxShadow = ''; card.style.transform = ''; }
        });

        if (userData.isReseller && userData.resellerLevel) {
          let activeCard;
          switch(userData.resellerLevel) {
            case 'beginner': activeCard = beginnerCard; break;
            case 'amateur': activeCard = amateurCard; break;
            case 'intermediate': activeCard = intermediateCard; break;
            case 'professional': activeCard = professionalCard; break;
          }
          if (activeCard) {
            const indicator = document.createElement('div');
            indicator.className = 'current-level-indicator';
            indicator.innerHTML = '<i class="fas fa-check"></i>';
            activeCard.appendChild(indicator);
            activeCard.style.boxShadow = `0 0 20px ${getLevelColor(userData.resellerLevel)}`;
            activeCard.style.transform = 'scale(1.05)';
          }
        }
      }

      function getLevelColor(level) {
        switch(level) {
          case 'beginner': return 'rgba(66, 165, 245, 0.5)';
          case 'amateur': return 'rgba(76, 175, 80, 0.5)';
          case 'intermediate': return 'rgba(255, 193, 7, 0.5)';
          case 'professional': return 'rgba(255, 87, 34, 0.5)';
          default: return 'rgba(255, 255, 255, 0.5)';
        }
      }

      // Update prices using normalized discount
      function updatePricesWithDiscount() {
        let discountPercentage = Number(userData.discountRateNormalized || 0);

        const normalPrices = document.querySelectorAll('.normal-price');
        const resellerPrices = document.querySelectorAll('.reseller-price');
        const savingsElements = document.querySelectorAll('.savings-percent');

        resellerPrices.forEach((element, index) => {
          const normalEl = normalPrices[index];
          const savingsEl = savingsElements[index];
          if (!normalEl) return;

          const originalPrice = element.getAttribute('data-original');
          if (!originalPrice) return;

          const normalPriceValue = parseInt(originalPrice, 10);
          if (!isNaN(normalPriceValue)) {
            const discountedPrice = Math.round(normalPriceValue * (1 - discountPercentage / 100));
            element.textContent = `${discountedPrice.toLocaleString('fr-FR')} FCFA`;

            if (savingsEl) {
              savingsEl.textContent = `${discountPercentage}%`;
            }
          }
        });
      }

      // Scroll animations (idem)
      function setupScrollAnimations() {
        const scrollElements = document.querySelectorAll('.scroll-animate');
        const elementInView = (el, dividend = 1) => {
          const elementTop = el.getBoundingClientRect().top;
          return (elementTop <= (window.innerHeight || document.documentElement.clientHeight) / dividend);
        };
        const displayScrollElement = (element) => element.classList.add('visible');
        const hideScrollElement = (element) => element.classList.remove('visible');
        const handleScrollAnimation = () => {
          scrollElements.forEach((el) => {
            if (elementInView(el, 1.2)) displayScrollElement(el); else hideScrollElement(el);
          });
        };
        window.addEventListener('scroll', handleScrollAnimation);
        handleScrollAnimation();
      }

      // becomeReseller (inchang√©)
      async function becomeReseller() {
        try {
          if (!currentUser) {
            alert("Veuillez vous connecter pour devenir revendeur");
            return;
          }
          becomeResellerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Activation...';
          becomeResellerBtn.disabled = true;

          await db.collection("users").doc(currentUser.uid).set({
            isReseller: true,
            resellerLevel: "beginner",
            discountRate: 5,
            resellerOrdersCount: 0,
            resellerSince: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });

          alert("F√©licitations ! Vous √™tes maintenant revendeur avec le niveau D√©butant (5% de remise).");
        } catch (error) {
          console.error("Erreur de mise √† jour du statut:", error);
          alert("Une erreur est survenue. Veuillez r√©essayer.");
          becomeResellerBtn.innerHTML = '<i class="fas fa-user-plus"></i> Devenir Revendeur';
          becomeResellerBtn.disabled = false;
        }
      }

      // resignAsReseller (inchang√©)
      async function resignAsReseller() {
        try {
          if (!currentUser || !userData.isReseller) return;

          const confirmResign = confirm("√ätes-vous s√ªr de vouloir d√©missionner de votre statut de revendeur ? Vous perdrez toutes vos remises et avantages.");
          if (!confirmResign) return;

          resignBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> D√©mission...';
          resignBtn.disabled = true;

          await db.collection("users").doc(currentUser.uid).set({
            isReseller: false,
            resellerLevel: null,
            discountRate: 0,
            resellerOrdersCount: 0,
            resellerEnded: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });

          alert("Vous avez d√©missionn√© avec succ√®s de votre statut de revendeur. Vos remises ont √©t√© d√©sactiv√©es.");
        } catch (error) {
          console.error("Erreur lors de la d√©mission:", error);
          alert("Une erreur est survenue. Veuillez r√©essayer.");
          resignBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> D√©missionner';
          resignBtn.disabled = false;
        }
      }

      // Events
      function attachEvents() {
        becomeResellerBtn.addEventListener('click', becomeReseller);
        resignBtn.addEventListener('click', resignAsReseller);
        quickDeposit.addEventListener('click', () => { window.location.href = "fonds.html"; });
      }

      // Init
      initializePage();
      attachEvents();
      setupScrollAnimations();
    });
  </script>
</body>
</html>