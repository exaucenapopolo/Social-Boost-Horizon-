<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Espace Revendeur — Social Boost Horizon</title>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <style>
    :root{
      --bg:#071026; --card:#15243a; --muted:rgba(255,255,255,0.75); --accent:#1E90FF; --gold:#FFD700;
    }
    *{box-sizing:border-box}
    body{font-family:Roboto,system-ui,-apple-system; margin:0; min-height:100vh; background:var(--bg); color:#fff; display:flex; flex-direction:column}
    header{display:flex; justify-content:space-between; align-items:center; padding:12px 18px; background:linear-gradient(90deg,#133064,#6a0dad); position:sticky; top:0}
    .logo{font-weight:700}
    .snap{display:flex; gap:8px; align-items:center}
    .snap .avatar{background:radial-gradient(circle at 20% 20%, #fffc00,#ffbc00); color:#071026; padding:6px 10px; border-radius:999px; font-weight:700}
    main{max-width:1100px; margin:18px auto; width:100%; padding:0 12px}
    .card{background:rgba(20,35,60,0.7); padding:16px; border-radius:12px; border:1px solid rgba(255,255,255,0.04); margin-bottom:14px}
    h2{font-family:Montserrat, sans-serif; margin-bottom:8px}
    .reseller-status{display:flex; gap:10px; flex-wrap:wrap}
    .status-card{background:rgba(255,255,255,0.02); padding:12px; border-radius:10px; min-width:160px; text-align:center}
    .reseller-actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .btn{padding:10px 14px; border-radius:999px; border:0; cursor:pointer; font-weight:700}
    .btn-primary{background:linear-gradient(45deg,#42A5F5,#4CAF50); color:#fff}
    .btn-secondary{background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(255,255,255,0.06)}
    .small{font-size:0.9rem; color:var(--muted)}
    .loading-spinner{display:inline-block; width:16px; height:16px; border:2px solid rgba(255,255,255,0.25); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite; vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    .notification{position:fixed; top:18px; right:18px; padding:12px 14px; border-radius:10px; z-index:9999; box-shadow:0 8px 30px rgba(0,0,0,.35)}
    @media (max-width:720px){ .reseller-status{flex-direction:column; align-items:center} }
  </style>
</head>
<body>
  <header>
    <div class="logo">SOCIAL <span style="color:var(--gold)">BOOST</span> HORIZON</div>
    <div class="snap">
      <div id="balanceWrapper" class="avatar" title="Solde">--</div>
      <button id="quickDeposit" class="btn btn-secondary">Déposer</button>
      <a href="profil.html" class="btn btn-secondary">Profil</a>
    </div>
  </header>

  <main>
    <section class="card">
      <h2><i class="fas fa-crown"></i> Programme Revendeur</h2>
      <p class="small">Activez/désactivez votre statut revendeur, consultez vos statistiques et voyez les prix revendeur.</p>

      <div style="display:flex; gap:12px; margin-top:12px; flex-wrap:wrap;">
        <div style="flex:1; min-width:240px">
          <div class="reseller-status">
            <div id="beginnerCard" class="status-card"><strong>Débutant</strong><div>5%</div><div class="small">5–6 / semaine</div></div>
            <div id="amateurCard" class="status-card"><strong>Amateur</strong><div>10%</div><div class="small">7–9 / semaine</div></div>
            <div id="intermediateCard" class="status-card"><strong>Intermédiaire</strong><div>15%</div><div class="small">10–19 / semaine</div></div>
            <div id="professionalCard" class="status-card"><strong>Professionnel</strong><div>20%</div><div class="small">20+ / semaine</div></div>
          </div>
        </div>

        <div style="flex:1; min-width:280px">
          <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:8px;">
            <div class="status-card"><div class="small">Niveau</div><div id="currentLevel" style="font-weight:700">—</div></div>
            <div class="status-card"><div class="small">Remise</div><div id="discountRate" style="font-weight:700">—</div></div>
            <div class="status-card"><div class="small">Commandes (7j)</div><div id="weeklyOrders" style="font-weight:700">—</div></div>
            <div class="status-card"><div class="small">Total commandes</div><div id="totalOrders" style="font-weight:700">—</div></div>
            <div class="status-card"><div class="small">Économies</div><div id="totalSavings" style="font-weight:700">—</div></div>
            <div class="status-card"><div class="small">Solde</div><div id="balanceAmount" style="font-weight:700">—</div></div>
          </div>
        </div>
      </div>

      <div class="reseller-actions">
        <button id="becomeResellerBtn" class="btn btn-primary"><i class="fas fa-user-plus"></i> Devenir Revendeur</button>
        <a id="ordersBtn" class="btn btn-secondary" href="commandes.html" style="display:none"><i class="fas fa-shopping-cart"></i> Mes Commandes</a>
        <a id="commanderBtn" class="btn btn-primary" href="command.html" style="display:none"><i class="fas fa-rocket"></i> Commander</a>
        <a id="dashboardBtn" class="btn btn-secondary" href="dashboard.html" style="display:none"><i class="fas fa-home"></i> Dashboard</a>
        <button id="resignBtn" class="btn btn-secondary" style="display:none"><i class="fas fa-sign-out-alt"></i> Démissionner</button>
        <button id="refreshStatsBtn" class="btn btn-secondary"><i class="fas fa-sync-alt"></i> Rafraîchir</button>
      </div>
    </section>

    <section class="card">
      <h2><i class="fas fa-tags"></i> Services / Prix</h2>
      <p class="small">Exemples — les prix revendeur s'actualisent selon votre remise.</p>
      <div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:10px; margin-top:12px;">
        <div class="status-card"><strong>Followers Instagram</strong><div class="small">Normal: 2 500 FCFA</div><div class="small">Revendeur: <span class="reseller-price" data-original="2500">—</span></div></div>
        <div class="status-card"><strong>Likes TikTok</strong><div class="small">Normal: 500 FCFA</div><div class="small">Revendeur: <span class="reseller-price" data-original="500">—</span></div></div>
        <div class="status-card"><strong>Vues YouTube</strong><div class="small">Normal: 1 550 FCFA</div><div class="small">Revendeur: <span class="reseller-price" data-original="1550">—</span></div></div>
      </div>
    </section>

    <section class="card small">
      <h2><i class="fas fa-info-circle"></i> Info</h2>
      <ul>
        <li>Le serveur expose les routes à la racine (ex: <code>/user</code>, <code>/become-reseller</code>).</li>
        <li>Si tu as configuré ton serveur sur une autre URL, modifie <code>SERVER_URL</code> dans le script ci-dessous.</li>
      </ul>
    </section>
  </main>

  <div id="notificationRoot" aria-live="polite"></div>

  <script>
  /*****************************************************************
   * IMPORTANT:
   * - Ce fichier suppose que ton server.js expose les routes à la
   *   racine (ex: https://.../health, https://.../user, /become-reseller).
   * - Si ton server est sur une URL différente remplace SERVER_URL.
   *****************************************************************/
  const SERVER_URL = window.__SERVER_URL__ || 'https://social-boost-exaucenapopolo2.replit.app';

  // Firebase — configure si nécessaire (même config que ton projet)
  const firebaseConfig = {
    apiKey: "AIzaSyD2JiDS0g8EkeNXxjO7_wGI3WznpPvcCCk",
    authDomain: "social-boost-horizon.firebaseapp.com",
    projectId: "social-boost-horizon",
    storageBucket: "social-boost-horizon.appspot.com",
    messagingSenderId: "43658165639",
    appId: "1:43658165639:web:b8f492dc6a25cd12fc6722"
  };

  if (typeof firebase !== 'undefined' && !firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const auth = firebase.auth ? firebase.auth() : null;
  const db = firebase.firestore ? firebase.firestore() : null;

  // DOM refs
  const balanceWrapper = document.getElementById('balanceWrapper');
  const balanceAmount = document.getElementById('balanceAmount');
  const becomeResellerBtn = document.getElementById('becomeResellerBtn');
  const resignBtn = document.getElementById('resignBtn');
  const ordersBtn = document.getElementById('ordersBtn');
  const commanderBtn = document.getElementById('commanderBtn');
  const dashboardBtn = document.getElementById('dashboardBtn');
  const refreshStatsBtn = document.getElementById('refreshStatsBtn');

  const currentLevelEl = document.getElementById('currentLevel');
  const discountRateEl = document.getElementById('discountRate');
  const weeklyOrdersEl = document.getElementById('weeklyOrders');
  const totalOrdersEl = document.getElementById('totalOrders');
  const totalSavingsEl = document.getElementById('totalSavings');

  const beginnerCard = document.getElementById('beginnerCard');
  const amateurCard = document.getElementById('amateurCard');
  const intermediateCard = document.getElementById('intermediateCard');
  const professionalCard = document.getElementById('professionalCard');

  const notificationRoot = document.getElementById('notificationRoot');

  let userData = {
    isReseller:false, resellerLevel:null, resellerWeeklyOrders:0,
    resellerTotalOrders:0, discountRate:0, balance:0, totalSavings:0
  };

  function notify(msg, type='info', timeout=4500){
    const n = document.createElement('div');
    n.className = 'notification';
    n.style.background = type==='error' ? '#d9534f' : (type==='success' ? '#28a745' : '#2196f3');
    n.textContent = msg;
    notificationRoot.appendChild(n);
    setTimeout(()=>{ n.style.opacity='0'; setTimeout(()=>n.remove(),300); }, timeout);
  }

  function setStat(el, val){ if(el) el.textContent = val; }

  function getLevelColor(level){
    if(!level) return '';
    const l = String(level).toLowerCase();
    if(l.includes('begin')) return '#42A5F5';
    if(l.includes('amateur')) return '#4CAF50';
    if(l.includes('inter')) return '#FFC107';
    if(l.includes('pro')) return '#FF5722';
    return '';
  }

  function updateLevelIndicators(){
    document.querySelectorAll('.current-level-indicator').forEach(el=>el.remove());
    [beginnerCard, amateurCard, intermediateCard, professionalCard].forEach(c=>{
      if(c){ c.style.boxShadow=''; c.style.transform=''; }
    });
    if(!userData.isReseller || !userData.resellerLevel) return;
    const lvl = String(userData.resellerLevel).toLowerCase();
    let active = null;
    if(lvl.includes('begin')) active = beginnerCard;
    else if(lvl.includes('amateur')) active = amateurCard;
    else if(lvl.includes('inter')) active = intermediateCard;
    else if(lvl.includes('pro')) active = professionalCard;
    if(!active) return;
    const badge = document.createElement('div');
    badge.className = 'current-level-indicator';
    badge.style.position='absolute';
    badge.style.top='-8px'; badge.style.right='-8px'; badge.style.background='#FFD700'; badge.style.color='#071026';
    badge.style.padding='6px'; badge.style.borderRadius='50%';
    badge.innerHTML = '✓';
    active.style.position='relative';
    active.appendChild(badge);
    active.style.boxShadow = `0 0 18px ${getLevelColor(userData.resellerLevel)}`;
    active.style.transform = 'scale(1.03)';
  }

  function updatePricesWithDiscount(){
    const discount = userData.isReseller ? Number(userData.discountRate || 0) : 0;
    document.querySelectorAll('.reseller-price').forEach(el=>{
      const original = Number(el.getAttribute('data-original') || el.dataset.original || 0);
      if(!isNaN(original)){
        const discounted = Math.round(original * (1 - discount/100));
        el.textContent = `${discounted.toLocaleString('fr-FR')} FCFA (${discount}% off)`;
      }
    });
  }

  function updateUI(){
    setStat(currentLevelEl, userData.isReseller ? (userData.resellerLevel || 'N/A') : 'Non revendeur');
    setStat(discountRateEl, (userData.discountRate || 0) + '%');
    setStat(weeklyOrdersEl, String(userData.resellerWeeklyOrders || 0));
    setStat(totalOrdersEl, String(userData.resellerTotalOrders || 0));
    setStat(totalSavingsEl, (userData.totalSavings || 0).toLocaleString('fr-FR') + ' FCFA');
    setStat(balanceAmount, (userData.balance || 0).toLocaleString('fr-FR') + ' FCFA');
    // buttons
    if(userData.isReseller){
      becomeResellerBtn.style.display='none';
      ordersBtn.style.display='inline-flex';
      commanderBtn.style.display='inline-flex';
      dashboardBtn.style.display='inline-flex';
      resignBtn.style.display='inline-flex';
    } else {
      becomeResellerBtn.style.display='inline-flex';
      ordersBtn.style.display='none';
      commanderBtn.style.display='none';
      dashboardBtn.style.display='none';
      resignBtn.style.display='none';
    }
    updatePricesWithDiscount();
    updateLevelIndicators();
  }

  // --- fetch helpers with robust HTML detection ---
  async function debugAndParse(res, endpoint){
    const ct = (res.headers.get('content-type') || '').toLowerCase();
    const text = await res.text();
    // If server returns HTML (index.html or error page), throw with snippet
    if(ct.includes('text/html') || text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')){
      const snippet = text.substring(0,300).replace(/\s+/g,' ');
      const err = new Error(`Le serveur a renvoyé du HTML au lieu du JSON pour ${endpoint}. Début du contenu: ${snippet}`);
      err.raw = text;
      err.contentType = ct;
      throw err;
    }
    // Try parse JSON
    try{
      return JSON.parse(text);
    }catch(e){
      const err = new Error(`Réponse non-JSON de ${endpoint} — parse échoué: ${e.message}`);
      err.raw = text;
      throw err;
    }
  }

  async function callServer(endpoint, method='GET', data=null){
    try{
      if(!auth || !auth.currentUser) throw new Error('Utilisateur non connecté.');
      const token = await auth.currentUser.getIdToken();
      const headers = { 'Authorization': `Bearer ${token}` };
      let body;
      if(data && ['POST','PUT','PATCH'].includes(method)){
        headers['Content-Type'] = 'application/json';
        body = JSON.stringify(data);
      }
      const url = SERVER_URL + endpoint;
      const res = await fetch(url, { method, headers, body });
      if (!res.ok) {
        // try to parse body to provide clearer message
        return await debugAndParse(res, endpoint);
      }
      return await debugAndParse(res, endpoint);
    } catch(err){
      console.error('callServer error', err);
      throw err;
    }
  }

  async function pingServerHealth(){
    try{
      const r = await fetch(SERVER_URL + '/health', { method:'GET', headers:{ Accept:'application/json' }});
      if(!r.ok){
        throw new Error(`Health failed ${r.status}`);
      }
      const ct = (r.headers.get('content-type')||'').toLowerCase();
      if(!ct.includes('application/json')) {
        // read text to show snippet
        const t = await r.text();
        throw new Error(`Health returned non-json (content-type: ${ct}) — début: ${t.slice(0,200).replace(/\s+/g,' ')}`);
      }
      const json = await r.json();
      return json && json.ok;
    }catch(e){
      console.error('pingServerHealth', e);
      notify('Impossible de contacter le serveur (' + e.message + ')','error',6000);
      return false;
    }
  }

  // --- main flows ---
  async function fetchUserData(){
    try{
      const res = await callServer('/user', 'GET');
      if(!res || !res.success) throw new Error(res && res.error ? res.error : 'Réponse invalide /user');
      const srv = res.user;
      userData = {
        isReseller: !!srv.isReseller,
        resellerLevel: srv.resellerLevel || null,
        resellerWeeklyOrders: Number(srv.resellerWeeklyOrders || 0),
        resellerTotalOrders: Number(srv.resellerTotalOrders || 0),
        discountRate: Number(srv.discountRate || 0),
        balance: Number(srv.balance || 0),
        totalSavings: Number(srv.totalSavings || 0),
        ...srv
      };
      updateUI();
      notify('Données utilisateur chargées', 'success', 1800);
      return userData;
    }catch(err){
      console.error('fetchUserData', err);
      notify(err.message || 'Erreur chargement user', 'error', 6000);
      throw err;
    }
  }

  async function becomeReseller(){
    if(!auth || !auth.currentUser){ notify('Veuillez vous connecter.', 'error'); return; }
    const orig = becomeResellerBtn.innerHTML;
    try{
      becomeResellerBtn.disabled = true;
      becomeResellerBtn.innerHTML = '<span class="loading-spinner"></span> Activation...';
      const res = await callServer('/become-reseller','POST');
      if(res && res.success){
        notify(res.message || 'Vous êtes maintenant revendeur','success');
        await fetchUserData();
      } else {
        throw new Error(res && (res.error || res.message) ? (res.error || res.message) : 'Activation échouée');
      }
    }catch(e){
      console.error('becomeReseller', e);
      notify(e.message || 'Erreur activation', 'error',6000);
    }finally{
      becomeResellerBtn.disabled = false;
      becomeResellerBtn.innerHTML = orig;
    }
  }

  async function resignAsReseller(){
    if(!confirm('Confirmer la démission ?')) return;
    const orig = resignBtn.innerHTML;
    try{
      resignBtn.disabled = true;
      resignBtn.innerHTML = '<span class="loading-spinner"></span> Démission...';
      const res = await callServer('/resign','POST');
      if(res && res.success){
        notify(res.message || 'Vous avez démissionné','info');
        await fetchUserData();
      } else {
        throw new Error(res && (res.error || res.message) ? (res.error || res.message) : 'Démission échouée');
      }
    }catch(e){
      console.error('resign', e);
      notify(e.message || 'Erreur démission', 'error',6000);
    }finally{
      resignBtn.disabled = false;
      resignBtn.innerHTML = orig;
    }
  }

  async function refreshResellerStats(){
    try{
      refreshStatsBtn.disabled = true;
      refreshStatsBtn.innerHTML = '<span class="loading-spinner"></span> Mise à jour...';
      const res = await callServer('/update-reseller-stats','GET');
      if(res && res.success){
        await fetchUserData();
        notify('Stats mises à jour', 'success');
      } else {
        notify('Mise à jour non réalisée', 'error',4000);
      }
    }catch(e){
      console.error('refreshResellerStats', e);
      notify(e.message || 'Erreur maj stats', 'error',6000);
    }finally{
      refreshStatsBtn.disabled = false;
      refreshStatsBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Rafraîchir';
    }
  }

  // attach events
  if(becomeResellerBtn) becomeResellerBtn.addEventListener('click', becomeReseller);
  if(resignBtn) resignBtn.addEventListener('click', resignAsReseller);
  if(refreshStatsBtn) refreshStatsBtn.addEventListener('click', refreshResellerStats);

  // FIREBASE auth state handling
  if(auth && auth.onAuthStateChanged){
    auth.onAuthStateChanged(async (user)=>{
      if(user){
        try{
          const healthy = await pingServerHealth();
          if(!healthy){
            notify('Serveur indisponible — vérifie SERVER_URL', 'error', 6000);
            return;
          }
          await fetchUserData();
          // listen realtime balance (optional) if firestore is available
          if(db && db.collection){
            try{
              const ref = db.collection('users').doc(user.uid);
              ref.onSnapshot(doc=>{
                if(!doc.exists) return;
                const d = doc.data() || {};
                if(typeof d.balance !== 'undefined'){
                  userData.balance = Number(d.balance || 0);
                  setStat(balanceAmount, userData.balance.toLocaleString('fr-FR') + ' FCFA');
                }
                if(typeof d.isReseller !== 'undefined') userData.isReseller = !!d.isReseller;
                if(typeof d.resellerLevel !== 'undefined') userData.resellerLevel = d.resellerLevel;
                if(typeof d.resellerWeeklyOrders !== 'undefined') userData.resellerWeeklyOrders = Number(d.resellerWeeklyOrders || 0);
                if(typeof d.resellerTotalOrders !== 'undefined') userData.resellerTotalOrders = Number(d.resellerTotalOrders || 0);
                if(typeof d.discountRate !== 'undefined') userData.discountRate = Number(d.discountRate || 0);
                if(typeof d.totalSavings !== 'undefined') userData.totalSavings = Number(d.totalSavings || 0);
                updateUI();
              });
            }catch(e){ console.warn('firestore listener not available', e); }
          }
        }catch(e){
          console.warn('init error', e);
        }
      } else {
        // user logged out — reset UI
        userData = { isReseller:false, resellerLevel:null, resellerWeeklyOrders:0, resellerTotalOrders:0, discountRate:0, balance:0, totalSavings:0 };
        updateUI();
      }
    });
  } else {
    console.warn('Firebase Auth unavailable — make sure Firebase scripts loaded');
  }

  // quick debug helper (open console to view)
  (function quickDebug(){
    console.log('RESS SELLER CLIENT — SERVER_URL=', SERVER_URL);
    console.log('Points de debug utiles:');
    console.log('- Si tu reçois HTML: vérifie que tu appelles la bonne URL (pas /api si ton server n\'a pas /api).');
    console.log('- Exécute dans un terminal: curl -i ' + SERVER_URL + '/health');
  })();

  </script>
</body>
</html>