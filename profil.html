<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mon Profil - Social Boost Horizon</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <style>
    :root {
      --sbh-dark-blue: #0A162B;
      --sbh-gradient-start: #1e3c72;
      --sbh-gradient-end: #6a0dad;
      --sbh-btn-color: #1E90FF;
      --sbh-icon-color: #4CAF50;
      --sbh-text-white: #FFFFFF;
      --sbh-light-blue: #4DA6FF;
      --sbh-accent: #FF6B6B;
      --success-green: #4CAF50;
      --error-red: #f44336;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Poppins', sans-serif;
      color: var(--sbh-text-white);
      background: var(--sbh-dark-blue);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    .background-animation {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: -1;
      background: linear-gradient(135deg, var(--sbh-dark-blue) 0%, #0f2744 50%, #1a1a3e 100%);
      overflow: hidden;
    }

    .background-animation::before {
      content: "";
      position: absolute;
      width: 2px; height: 2px;
      border-radius: 50%;
      background: white;
      box-shadow: 100px 50px white, 200px 150px white, 300px 250px white,
        400px 70px white, 50px 300px white, 500px 400px white, 600px 120px white,
        700px 350px white, 80px 10px white, 420px 220px white, 680px 50px white,
        150px 450px white, 550px 320px white;
      animation: twinkle 5s infinite alternate;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.1); }
    }

    header {
      position: sticky;
      top: 0;
      background: linear-gradient(45deg, var(--sbh-gradient-start), var(--sbh-gradient-end));
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .logo-text {
      display: flex;
      flex-direction: column;
      text-decoration: none;
      line-height: 1.2;
    }

    .logo-text .text-social,
    .logo-text .text-horizon {
      color: var(--sbh-text-white);
      font-size: 1.2rem;
      font-weight: 600;
    }

    .logo-text .boost-line {
      display: flex;
      align-items: center;
      color: var(--sbh-icon-color);
      font-size: 1.6rem;
      font-weight: 800;
    }

    .logo-text .boost-line i {
      margin-right: 6px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .hamburger-btn {
      font-size: 1.8rem;
      color: var(--sbh-text-white);
      cursor: pointer;
      transition: transform 0.3s;
      background: none;
      border: none;
    }

    .hamburger-btn:hover { transform: scale(1.1); }

    .mobile-menu {
      display: none;
      position: absolute;
      top: 68px;
      right: 2rem;
      background: rgba(10, 22, 43, 0.98);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      padding: 1.5rem;
      flex-direction: column;
      z-index: 200;
      min-width: 260px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
    }

    header.open .mobile-menu { display: flex; }

    .mobile-menu a {
      color: var(--sbh-text-white);
      text-decoration: none;
      padding: 0.8rem 1rem;
      font-weight: 500;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
    }

    .mobile-menu a:last-child { border-bottom: none; }
    .mobile-menu a i { margin-right: 12px; color: var(--sbh-light-blue); width: 24px; }
    .mobile-menu a:hover { background: rgba(30, 60, 114, 0.4); border-radius: 8px; transform: translateX(5px); }

    .profile-container {
      max-width: 600px;
      margin: 40px auto;
      padding: 0 20px;
      flex: 1;
    }

    .profile-card {
      background: linear-gradient(145deg, rgba(20, 35, 65, 0.8), rgba(15, 25, 50, 0.9));
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 20px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
      padding: 40px 35px;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .profile-card::before {
      content: "";
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 5px;
      background: linear-gradient(90deg, var(--sbh-gradient-start), var(--sbh-gradient-end), var(--sbh-icon-color));
    }

    .avatar-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 30px;
      position: relative;
    }

    .avatar-container {
      position: relative;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      cursor: pointer;
    }

    .avatar {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--sbh-gradient-start), var(--sbh-gradient-end));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      color: white;
      font-weight: 700;
      box-shadow: 0 8px 25px rgba(30, 144, 255, 0.3);
      border: 4px solid rgba(255, 255, 255, 0.2);
      overflow: hidden;
      object-fit: cover;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .avatar-edit-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 2rem;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    .avatar-container:hover .avatar-edit-overlay {
      opacity: 1;
    }

    .avatar-edit-overlay i {
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
    }

    .avatar-section h2 {
      margin-top: 15px;
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--sbh-text-white);
    }

    .avatar-section .member-badge {
      margin-top: 8px;
      padding: 6px 16px;
      background: linear-gradient(90deg, var(--sbh-icon-color), #45a049);
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .form-section h3 {
      font-size: 1.2rem;
      color: var(--sbh-light-blue);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .field {
      margin-bottom: 22px;
      position: relative;
    }

    .field label {
      display: flex;
      align-items: center;
      font-weight: 500;
      margin-bottom: 10px;
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.95rem;
    }

    .field label i {
      margin-right: 10px;
      color: var(--sbh-light-blue);
      width: 20px;
    }

    .field input {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      font-size: 1rem;
      background: rgba(0, 0, 0, 0.25);
      color: var(--sbh-text-white);
      transition: all 0.3s ease;
      font-family: 'Poppins', sans-serif;
    }

    .field input:focus {
      border-color: var(--sbh-btn-color);
      outline: none;
      box-shadow: 0 0 0 4px rgba(30, 144, 255, 0.15);
      background: rgba(0, 0, 0, 0.35);
    }

    .field input[readonly] {
      background: rgba(0, 0, 0, 0.15);
      border-color: rgba(255, 255, 255, 0.08);
      cursor: not-allowed;
      opacity: 0.7;
    }

    .field input:not([readonly]) {
      border-color: var(--sbh-icon-color);
      background: rgba(0, 0, 0, 0.35);
    }

    .toggle-password {
      position: absolute;
      top: 45px;
      right: 15px;
      cursor: pointer;
      color: rgba(255, 255, 255, 0.6);
      font-size: 1.1rem;
      transition: color 0.3s;
    }

    .toggle-password:hover { color: var(--sbh-light-blue); }

    .password-hint {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.5);
      margin-top: 6px;
      display: none;
    }

    .buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    .btn {
      flex: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 14px 25px;
      border: none;
      border-radius: 50px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      font-family: 'Montserrat', sans-serif;
      font-size: 1rem;
      cursor: pointer;
      gap: 8px;
    }

    .btn-edit {
      background: linear-gradient(45deg, var(--sbh-gradient-start), var(--sbh-btn-color));
      color: #fff;
      box-shadow: 0 6px 20px rgba(30, 144, 255, 0.3);
    }

    .btn-edit:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(30, 144, 255, 0.4);
    }

    .btn-save {
      background: linear-gradient(45deg, var(--sbh-icon-color), #45a049);
      color: #fff;
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
    }

    .btn-save:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4);
    }

    .btn-save:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .btn-cancel {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .btn-cancel:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-3px);
    }

    .btn-logout {
      background: linear-gradient(45deg, #dc3545, #c82333);
      color: #fff;
      box-shadow: 0 6px 20px rgba(220, 53, 69, 0.3);
    }

    .btn-logout:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(220, 53, 69, 0.4);
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .security-tips {
      margin-top: 30px;
      padding: 20px;
      background: rgba(76, 175, 80, 0.1);
      border-radius: 15px;
      border-left: 4px solid var(--sbh-icon-color);
    }

    .security-tips h4 {
      color: var(--sbh-icon-color);
      font-size: 1.1rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .security-tips ul {
      list-style: none;
      padding: 0;
    }

    .security-tips li {
      padding: 8px 0;
      color: rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
    }

    .security-tips li i {
      color: var(--sbh-icon-color);
      font-size: 0.8rem;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(145deg, rgba(20, 35, 65, 0.95), rgba(15, 25, 50, 0.98));
      border-radius: 25px;
      padding: 30px;
      max-width: 700px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      animation: modalFadeIn 0.3s;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-header h3 {
      color: var(--sbh-light-blue);
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-close {
      background: none;
      border: none;
      color: rgba(255,255,255,0.6);
      font-size: 1.8rem;
      cursor: pointer;
      transition: color 0.3s;
    }

    .modal-close:hover {
      color: var(--sbh-accent);
    }

    .avatar-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .avatar-option {
      border-radius: 15px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s;
      border: 3px solid transparent;
      aspect-ratio: 1;
      background: rgba(255,255,255,0.05);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .avatar-option img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .avatar-option.selected {
      border-color: var(--sbh-icon-color);
      transform: scale(1.05);
      box-shadow: 0 0 15px var(--sbh-icon-color);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      margin-top: 20px;
    }

    .btn-modal {
      padding: 12px 30px;
      border: none;
      border-radius: 50px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-modal-primary {
      background: linear-gradient(45deg, var(--sbh-icon-color), #45a049);
      color: white;
    }

    .btn-modal-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
    }

    .btn-modal-secondary {
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .btn-modal-secondary:hover {
      background: rgba(255,255,255,0.2);
    }

    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
    }

    .notification {
      display: flex;
      align-items: center;
      padding: 18px 25px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      background: linear-gradient(135deg, rgba(20, 35, 65, 0.98), rgba(15, 25, 50, 0.98));
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      font-weight: 500;
      max-width: 400px;
      transform: translateX(120%);
      animation: slideIn 0.5s forwards;
    }

    .notification.success {
      border-left: 5px solid var(--success-green);
    }

    .notification.error {
      border-left: 5px solid var(--error-red);
    }

    .notification-icon {
      font-size: 28px;
      margin-right: 15px;
    }

    .notification.success .notification-icon { color: var(--success-green); }
    .notification.error .notification-icon { color: var(--error-red); }

    @keyframes slideIn {
      to { transform: translateX(0); }
    }

    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      pointer-events: none;
      z-index: 99999;
    }

    footer {
      background: linear-gradient(to right, var(--sbh-gradient-start), var(--sbh-gradient-end));
      color: var(--sbh-text-white);
      padding: 2rem;
      text-align: center;
      margin-top: auto;
    }

    footer p {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(10, 22, 43, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-overlay .spinner {
      width: 50px;
      height: 50px;
      border-width: 5px;
    }

    .loading-overlay p {
      margin-top: 20px;
      font-size: 1.1rem;
    }

    @media (max-width: 600px) {
      .profile-container { padding: 0 15px; margin: 20px auto; }
      .profile-card { padding: 25px 20px; }
      .avatar-container { width: 100px; height: 100px; }
      .avatar { font-size: 2.5rem; }
      .buttons { flex-direction: column; }
      .btn { width: 100%; }
      header { padding: 1rem; }
      .mobile-menu { right: 1rem; }
      .avatar-grid { grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="background-animation"></div>
  <div class="notification-container" id="notificationContainer"></div>
  
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <p>Chargement du profil...</p>
  </div>

  <header data-aos="fade-down">
    <a href="dashboard.html" class="logo-text">
      <span class="text-social">SOCIAL</span>
      <div class="boost-line">
        <i class="fa-solid fa-rocket"></i>
        <span class="text-boost">BOOST</span>
      </div>
      <span class="text-horizon">HORIZON</span>
    </a>
    <button class="hamburger-btn" id="hamburgerBtn" aria-label="Menu">
      <i class="fa-solid fa-bars"></i>
    </button>
    <div class="mobile-menu">
      <a href="dashboard.html"><i class="fa-solid fa-house"></i> Accueil</a>
      <a href="wallet.html"><i class="fa-solid fa-wallet"></i> Mon portefeuille</a>
      <a href="commander.html"><i class="fa-solid fa-shopping-cart"></i> Commander</a>
      <a href="commandes.html"><i class="fa-solid fa-list"></i> Mes commandes</a>
      <a href="parrainage.html"><i class="fa-solid fa-handshake"></i> Parrainage</a>
      <a href="fonds.html"><i class="fa-solid fa-money-bill"></i> Ajouter des fonds</a>
    </div>
  </header>

  <div class="profile-container">
    <div class="profile-card" data-aos="fade-up">
      <div class="avatar-section">
        <div class="avatar-container" id="avatarContainer" style="cursor: default;">
          <div class="avatar" id="userAvatar">
            <!-- Avatar image or letter will be inserted via JS -->
          </div>
          <div class="avatar-edit-overlay" id="avatarEditOverlay" style="display: none; pointer-events: none;">
            <i class="fa-solid fa-camera"></i>
          </div>
        </div>
        <h2 id="userDisplayName">Chargement...</h2>
        <div class="member-badge">
          <i class="fa-solid fa-star"></i>
          <span>Membre actif</span>
        </div>
      </div>

      <div class="form-section">
        <h3><i class="fa-solid fa-user-pen"></i> Informations du compte</h3>
        
        <form id="profileForm">
          <div class="field">
            <label for="displayName"><i class="fa-solid fa-user"></i> Nom d'utilisateur</label>
            <input type="text" id="displayName" readonly />
          </div>

          <div class="field">
            <label for="email"><i class="fa-solid fa-envelope"></i> Adresse e-mail</label>
            <input type="email" id="email" readonly />
          </div>

          <div class="field">
            <label for="phone"><i class="fa-solid fa-phone"></i> Numero de telephone</label>
            <input type="tel" id="phone" placeholder="Ex: +237 6XX XXX XXX" readonly />
          </div>

          <div class="field">
            <label for="newPassword"><i class="fa-solid fa-lock"></i> Nouveau mot de passe</label>
            <input type="password" id="newPassword" placeholder="Laisser vide pour ne pas changer" readonly />
            <i class="fa-solid fa-eye toggle-password" id="togglePassword"></i>
            <p class="password-hint" id="passwordHint">Minimum 6 caracteres</p>
          </div>

          <div class="buttons" id="viewButtons">
            <button type="button" id="editBtn" class="btn btn-edit">
              <i class="fa-solid fa-pen"></i> Modifier
            </button>
            <button type="button" id="logoutBtn" class="btn btn-logout">
              <i class="fa-solid fa-sign-out-alt"></i> Deconnexion
            </button>
          </div>

          <div class="buttons" id="editButtons" style="display: none;">
            <button type="submit" id="saveBtn" class="btn btn-save">
              <span id="saveSpinner" style="display:none;" class="spinner"></span>
              <span id="saveText"><i class="fa-solid fa-check"></i> Enregistrer</span>
            </button>
            <button type="button" id="cancelBtn" class="btn btn-cancel">
              <i class="fa-solid fa-times"></i> Annuler
            </button>
          </div>
        </form>
      </div>

      <div class="security-tips">
        <h4><i class="fa-solid fa-shield-halved"></i> Conseils de securite</h4>
        <ul>
          <li><i class="fa-solid fa-check"></i> Ne partagez jamais votre mot de passe</li>
          <li><i class="fa-solid fa-check"></i> Utilisez un mot de passe unique</li>
          <li><i class="fa-solid fa-check"></i> Changez regulierement votre mot de passe</li>
          <li><i class="fa-solid fa-check"></i> Verifiez toujours l'URL du site</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Modal de sélection d'avatar -->
  <div class="modal" id="avatarModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fa-solid fa-images"></i> Choisissez votre photo de profil</h3>
        <button class="modal-close" id="closeModalBtn">&times;</button>
      </div>
      <div class="avatar-grid" id="avatarGrid">
        <!-- Les images seront chargées dynamiquement via JS -->
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-secondary" id="cancelModalBtn">Annuler</button>
        <button class="btn-modal btn-modal-primary" id="selectAvatarBtn">Choisir</button>
      </div>
    </div>
  </div>

  <footer>
    <p>Social Boost Horizon - Tous droits reserves 2025</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    const BACKEND_URL = 'https://social-boost-exaucenapopolo2.replit.app';
    
    const firebaseConfig = {
      apiKey: "AIzaSyD2JiDS0g8EkeNXxjO7_wGI3WznpPvcCCk",
      authDomain: "social-boost-horizon.firebaseapp.com",
      projectId: "social-boost-horizon",
      storageBucket: "social-boost-horizon.appspot.com",
      messagingSenderId: "43658165639",
      appId: "1:43658165639:web:b8f492dc6a25cd12fc6722"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let originalData = {};
    let isEditMode = false;

    // Liste des photos de profil (URLs)
    const profilePhotos = [
      "https://raw.githubusercontent.com/exaucenapopolo/Social-Boost-Horizon-/refs/heads/main/assets/Photo/49391629-jeune-homme-avatar-personnage-du-avatar-homme-icone-dessin-anime-illustration-gratuit-vectoriel.jpg",
      "https://raw.githubusercontent.com/exaucenapopolo/Social-Boost-Horizon-/refs/heads/main/assets/Photo/femme%201.png",
      "https://raw.githubusercontent.com/exaucenapopolo/Social-Boost-Horizon-/refs/heads/main/assets/Photo/femme%202.jpg",
      "https://raw.githubusercontent.com/exaucenapopolo/Social-Boost-Horizon-/refs/heads/main/assets/Photo/femme%203.png",
      "https://raw.githubusercontent.com/exaucenapopolo/Social-Boost-Horizon-/refs/heads/main/assets/Photo/femme%204.jpeg",
      "https://raw.githubusercontent.com/exaucenapopolo/Social-Boost-Horizon-/refs/heads/main/assets/Photo/femme%205.jpeg",
      "https://raw.githubusercontent.com/exaucenapopolo/Social-Boost-Horizon-/refs/heads/main/assets/Photo/illustration-du-jeune-homme-souriant_1308-174669.jpg",
      "https://raw.githubusercontent.com/exaucenapopolo/Social-Boost-Horizon-/refs/heads/main/assets/Photo/man-with-beard-avatar-character-isolated-icon-free-vector.jpg",
      "https://raw.githubusercontent.com/exaucenapopolo/Social-Boost-Horizon-/refs/heads/main/assets/Photo/pngtree-man-avatar-image-for-profile-png-image_13001877.png",
      "https://raw.githubusercontent.com/exaucenapopolo/Social-Boost-Horizon-/refs/heads/main/assets/Photo/pngtree-man-avatar-image-for-profile-png-image_13001882.png",
      "https://raw.githubusercontent.com/exaucenapopolo/Social-Boost-Horizon-/refs/heads/main/assets/Photo/figure-detaillee-vieil-homme-tenant-lettre_1077802-376424.jpg"
    ];

    // Variable pour stocker l'URL temporairement sélectionnée dans le modal
    let selectedPhotoURL = null;
    // Variable pour stocker l'URL actuelle (celle dans Firestore)
    let currentPhotoURL = null;

    document.addEventListener('DOMContentLoaded', function() {
      AOS.init({ duration: 800, once: true });

      const header = document.querySelector('header');
      const hamburger = document.getElementById('hamburgerBtn');
      hamburger.addEventListener('click', () => header.classList.toggle('open'));
      document.addEventListener('click', (e) => {
        if (!header.contains(e.target) && header.classList.contains('open')) {
          header.classList.remove('open');
        }
      });

      const togglePwd = document.getElementById('togglePassword');
      const pwdInput = document.getElementById('newPassword');
      togglePwd.addEventListener('click', () => {
        const type = pwdInput.type === 'password' ? 'text' : 'password';
        pwdInput.type = type;
        togglePwd.classList.toggle('fa-eye');
        togglePwd.classList.toggle('fa-eye-slash');
      });

      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          window.location.href = 'login.html';
          return;
        }
        
        currentUser = user;
        await loadUserProfile(user);
        document.getElementById('loadingOverlay').style.display = 'none';
      });

      document.getElementById('editBtn').addEventListener('click', enterEditMode);
      document.getElementById('cancelBtn').addEventListener('click', exitEditMode);
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('profileForm').addEventListener('submit', saveProfile);

      // Gestion du modal
      const modal = document.getElementById('avatarModal');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const cancelModalBtn = document.getElementById('cancelModalBtn');
      const selectAvatarBtn = document.getElementById('selectAvatarBtn');
      const avatarContainer = document.getElementById('avatarContainer');

      // Ouvrir le modal uniquement en mode édition
      avatarContainer.addEventListener('click', () => {
        if (isEditMode) {
          openAvatarModal();
        }
      });

      closeModalBtn.addEventListener('click', closeAvatarModal);
      cancelModalBtn.addEventListener('click', closeAvatarModal);
      window.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeAvatarModal();
        }
      });

      selectAvatarBtn.addEventListener('click', () => {
        if (selectedPhotoURL) {
          // Mettre à jour l'affichage temporaire
          updateAvatarDisplay(selectedPhotoURL);
          closeAvatarModal();
        } else {
          showNotification('Veuillez sélectionner une photo', false);
        }
      });

      // Remplir la grille d'avatars
      populateAvatarGrid();
    });

    async function loadUserProfile(user) {
      const avatarEl = document.getElementById('userAvatar');
      const displayNameHeader = document.getElementById('userDisplayName');
      const displayNameInput = document.getElementById('displayName');
      const emailInput = document.getElementById('email');
      const phoneInput = document.getElementById('phone');

      const displayName = user.displayName || 'Utilisateur';
      displayNameHeader.textContent = displayName;
      displayNameInput.value = displayName;
      emailInput.value = user.email || '';

      try {
        const doc = await db.collection('users').doc(user.uid).get();
        if (doc.exists) {
          const data = doc.data();
          phoneInput.value = data.phone || '';
          currentPhotoURL = data.photoURL || null;
          originalData = {
            displayName: displayName,
            email: user.email,
            phone: data.phone || '',
            photoURL: currentPhotoURL
          };
        } else {
          currentPhotoURL = null;
          originalData = {
            displayName: displayName,
            email: user.email,
            phone: '',
            photoURL: null
          };
        }
      } catch (err) {
        console.error('Erreur chargement profil:', err);
        originalData = {
          displayName: displayName,
          email: user.email,
          phone: '',
          photoURL: null
        };
      }

      // Mettre à jour l'affichage de l'avatar
      updateAvatarDisplay(currentPhotoURL, displayName);
    }

    function updateAvatarDisplay(photoURL, displayName) {
      const avatarEl = document.getElementById('userAvatar');
      if (photoURL) {
        avatarEl.innerHTML = `<img src="${photoURL}" alt="Avatar" style="width:100%; height:100%; object-fit:cover;">`;
      } else {
        const name = displayName || document.getElementById('userDisplayName').textContent || 'U';
        avatarEl.innerHTML = name.charAt(0).toUpperCase();
        avatarEl.style.background = 'linear-gradient(135deg, var(--sbh-gradient-start), var(--sbh-gradient-end))';
      }
    }

    function enterEditMode() {
      isEditMode = true;
      document.getElementById('displayName').readOnly = false;
      document.getElementById('email').readOnly = false;
      document.getElementById('phone').readOnly = false;
      document.getElementById('newPassword').readOnly = false;
      document.getElementById('passwordHint').style.display = 'block';
      
      document.getElementById('viewButtons').style.display = 'none';
      document.getElementById('editButtons').style.display = 'flex';

      // Activer le clic sur l'avatar
      document.getElementById('avatarContainer').style.cursor = 'pointer';
      document.getElementById('avatarEditOverlay').style.display = 'flex';
      document.getElementById('avatarEditOverlay').style.pointerEvents = 'none'; // pour ne pas bloquer le clic
    }

    function exitEditMode() {
      isEditMode = false;
      document.getElementById('displayName').value = originalData.displayName;
      document.getElementById('email').value = originalData.email;
      document.getElementById('phone').value = originalData.phone;
      document.getElementById('newPassword').value = '';
      
      document.getElementById('displayName').readOnly = true;
      document.getElementById('email').readOnly = true;
      document.getElementById('phone').readOnly = true;
      document.getElementById('newPassword').readOnly = true;
      document.getElementById('passwordHint').style.display = 'none';
      
      document.getElementById('viewButtons').style.display = 'flex';
      document.getElementById('editButtons').style.display = 'none';

      // Désactiver le clic sur l'avatar
      document.getElementById('avatarContainer').style.cursor = 'default';
      document.getElementById('avatarEditOverlay').style.display = 'none';

      // Restaurer l'avatar original
      updateAvatarDisplay(originalData.photoURL, originalData.displayName);
    }

    async function saveProfile(e) {
      e.preventDefault();
      
      const saveBtn = document.getElementById('saveBtn');
      const saveSpinner = document.getElementById('saveSpinner');
      const saveText = document.getElementById('saveText');
      
      saveBtn.disabled = true;
      saveSpinner.style.display = 'inline-block';
      saveText.innerHTML = 'Enregistrement...';

      const newDisplayName = document.getElementById('displayName').value.trim();
      const newEmail = document.getElementById('email').value.trim();
      const newPhone = document.getElementById('phone').value.trim();
      const newPassword = document.getElementById('newPassword').value;

      if (!newDisplayName) {
        showNotification('Le nom d\'utilisateur est requis', false);
        resetSaveButton();
        return;
      }

      if (!newEmail || !isValidEmail(newEmail)) {
        showNotification('Email invalide', false);
        resetSaveButton();
        return;
      }

      if (newPassword && newPassword.length < 6) {
        showNotification('Le mot de passe doit contenir au moins 6 caracteres', false);
        resetSaveButton();
        return;
      }

      try {
        // Vérifier si la photo a changé
        const photoChanged = selectedPhotoURL && selectedPhotoURL !== originalData.photoURL;
        const photoToSave = photoChanged ? selectedPhotoURL : originalData.photoURL;

        // Appel au backend pour mettre à jour les infos (sans la photo)
        const idToken = await currentUser.getIdToken();
        
        const response = await fetch(BACKEND_URL + '/api/update-profile', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + idToken
          },
          body: JSON.stringify({
            userId: currentUser.uid,
            displayName: newDisplayName,
            email: newEmail,
            phone: newPhone,
            newPassword: newPassword || undefined
            // On n'envoie pas photoURL ici, on suppose que le backend ne le gère pas
          })
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error(data.error || 'Erreur lors de la mise a jour');
        }

        // Si la photo a changé, mettre à jour Firestore directement
        if (photoChanged) {
          await db.collection('users').doc(currentUser.uid).update({
            photoURL: photoToSave
          });
          currentPhotoURL = photoToSave;
        }

        // Mettre à jour les données originales
        originalData = {
          displayName: newDisplayName,
          email: newEmail,
          phone: newPhone,
          photoURL: photoToSave
        };

        document.getElementById('userDisplayName').textContent = newDisplayName;
        document.getElementById('newPassword').value = '';
        selectedPhotoURL = null; // Réinitialiser

        exitEditMode();
        showNotification('Profil mis à jour avec succès !', true);
        launchConfetti();

        if (newEmail !== currentUser.email || newPassword) {
          setTimeout(() => {
            showNotification('Vous allez être redirigé vers la connexion...', true);
            setTimeout(() => {
              auth.signOut().then(() => {
                window.location.href = 'login.html';
              });
            }, 2000);
          }, 3000);
        }

      } catch (err) {
        console.error('Erreur sauvegarde:', err);
        showNotification(err.message, false);
        // Si erreur, on restaure l'avatar original
        updateAvatarDisplay(originalData.photoURL, originalData.displayName);
      } finally {
        resetSaveButton();
      }
    }

    function resetSaveButton() {
      const saveBtn = document.getElementById('saveBtn');
      const saveSpinner = document.getElementById('saveSpinner');
      const saveText = document.getElementById('saveText');
      
      saveBtn.disabled = false;
      saveSpinner.style.display = 'none';
      saveText.innerHTML = '<i class="fa-solid fa-check"></i> Enregistrer';
    }

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function logout() {
      if (confirm('Voulez-vous vraiment vous déconnecter ?')) {
        auth.signOut().then(() => {
          window.location.href = 'login.html';
        }).catch(err => {
          showNotification('Erreur de déconnexion', false);
        });
      }
    }

    // Fonctions pour le modal
    function populateAvatarGrid() {
      const grid = document.getElementById('avatarGrid');
      grid.innerHTML = '';
      profilePhotos.forEach((url, index) => {
        const option = document.createElement('div');
        option.className = 'avatar-option';
        option.dataset.url = url;
        option.dataset.index = index;
        option.innerHTML = `<img src="${url}" alt="Avatar ${index+1}" loading="lazy">`;
        option.addEventListener('click', () => {
          // Enlever la sélection précédente
          document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
          option.classList.add('selected');
          selectedPhotoURL = url;
        });
        grid.appendChild(option);
      });
    }

    function openAvatarModal() {
      const modal = document.getElementById('avatarModal');
      // Pré-sélectionner l'image actuelle si elle existe dans la liste
      selectedPhotoURL = currentPhotoURL; // Initialiser avec l'actuelle
      document.querySelectorAll('.avatar-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.url === currentPhotoURL) {
          opt.classList.add('selected');
        }
      });
      modal.classList.add('active');
    }

    function closeAvatarModal() {
      const modal = document.getElementById('avatarModal');
      modal.classList.remove('active');
      // Ne pas modifier selectedPhotoURL ici, on attend le choix ou l'annulation
    }

    function showNotification(message, isSuccess) {
      const container = document.getElementById('notificationContainer');
      const notification = document.createElement('div');
      notification.className = `notification ${isSuccess ? 'success' : 'error'}`;
      
      notification.innerHTML = `
        <div class="notification-icon">${isSuccess ? '<i class="fa-solid fa-check-circle"></i>' : '<i class="fa-solid fa-times-circle"></i>'}</div>
        <div class="notification-text">${message}</div>
      `;
      
      container.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideIn 0.5s reverse forwards';
        setTimeout(() => notification.remove(), 500);
      }, 4000);
    }

    function launchConfetti() {
      const colors = ['#4CAF50', '#1E90FF', '#FF6B6B', '#FFD700', '#9C27B0', '#FF9800'];
      const confettiCount = 150;
      
      for (let i = 0; i < confettiCount; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + 'vw';
          confetti.style.top = '-10px';
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
          
          const shapes = ['circle', 'square', 'triangle'];
          const shape = shapes[Math.floor(Math.random() * shapes.length)];
          if (shape === 'circle') {
            confetti.style.borderRadius = '50%';
          } else if (shape === 'triangle') {
            confetti.style.width = '0';
            confetti.style.height = '0';
            confetti.style.borderLeft = '5px solid transparent';
            confetti.style.borderRight = '5px solid transparent';
            confetti.style.borderBottom = '10px solid ' + colors[Math.floor(Math.random() * colors.length)];
            confetti.style.backgroundColor = 'transparent';
          }
          
          document.body.appendChild(confetti);
          
          const animDuration = 3 + Math.random() * 2;
          const horizontalDrift = (Math.random() - 0.5) * 200;
          
          confetti.animate([
            { 
              top: '-10px', 
              transform: `rotate(0deg) translateX(0px)`,
              opacity: 1
            },
            { 
              top: '100vh', 
              transform: `rotate(${720 + Math.random() * 360}deg) translateX(${horizontalDrift}px)`,
              opacity: 0
            }
          ], {
            duration: animDuration * 1000,
            easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
          });
          
          setTimeout(() => confetti.remove(), animDuration * 1000);
        }, i * 20);
      }
    }
  </script>
</body>
</html>